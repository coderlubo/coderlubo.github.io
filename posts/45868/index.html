<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    <meta name="description" content="Hexo Theme Redefine">
    <meta name="author" content="Lubo">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/posts/45868/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    <meta property="og:type" content="article">
    <meta property="og:title" content="区块链技术">
    <meta property="og:description" content="Hexo Theme Redefine">
    <meta property="og:url" content="http://example.composts/45868/">
    <meta property="og:image" content="/images/redefine-logo.svg">
    <meta property="og:site_name" content="Lubo&#39;s Blog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="区块链技术">
    <meta name="twitter:description" content="Hexo Theme Redefine">
    <meta name="twitter:image" content="/images/redefine-logo.svg">
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-logo.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-logo.svg">
    <meta name="theme-color" content="#005080">
    <link rel="shortcut icon" href="/images/redefine-logo.svg">
    
    <title>
        
            区块链技术 -
        
        Lubo&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/assets/fonts.css">
    
    
    
    
        <link rel="preconnect" href="https://evan.beee.top" crossorigin>
    
    <script id="hexo-configurations">
    let REDEFINE = window.REDEFINE || {};
    REDEFINE.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    REDEFINE.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#005080","avatar":"/images/1.svg","favicon":"/images/redefine-logo.svg","article_img_align":"center","right_side_width":"210px","content_max_width":"1000px","nav_color":{"left":"#000000","right":"#DCDCDC","transparency":40},"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_image":{"light":"https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/08/2ad62c38f0b41506ca9ed2f57ed549c4-bg2-134b10.jpg","dark":"https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/08/2ad62c38f0b41506ca9ed2f57ed549c4-bg2-134b10.jpg"},"title_color":{"light":"#000","dark":"#d1d1b6"},"description":"This is Lubo's Blog","custom_font":{"enable":false,"font_family":null,"font_url":null}},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_block":{"copy":true,"style":"simple","custom_font":{"enable":false,"font_family":null,"font_url":null}},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"1.1.3","friend_links":{"columns":2},"home_article":{"date_format":"auto","category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":3}}};
    REDEFINE.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/fontawesome/regular.min.css">
    
    
    
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="menu-wrapper">
    
    <div class="menu-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Lubo&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="pc">
                <ul class="menu-list">
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="menu-drawer">
        <ul class="drawer-menu-list">
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">区块链技术</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/1.svg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Lubo</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="pc">2021-08-08 10:25:57</span>
        <span class="mobile">2021-08-08 10:25</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="pc">2023-03-11 09:25:07</span>
            <span class="mobile">2023-03-11 09:25</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Blockchain/">Blockchain</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/btc/">btc</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1>比特币</h1>
<h4>2021年8月8日</h4>
<hr>
<h2 id="一、概述">一、概述</h2>
<h3 id="人类交易发展史">人类交易发展史</h3>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/80d6f6e9fe91bebd2d27cc47319a697d-%E4%BA%BA%E7%B1%BB%E4%BA%A4%E6%98%93%E5%8F%91%E5%B1%95%E5%8F%B2-64fe7d.png"
                      alt=""
                ></p>
<h3 id="比特币诞生">比特币诞生</h3>
<blockquote>
<p>纸币的风险：政府倒台、战乱、治理不力、经济危机</p>
<p>比特币诞生背景</p>
<ul>
<li>
<p>08年金融危机</p>
</li>
<li>
<p>密码朋克组织</p>
</li>
</ul>
<p>直接原因：金融危机，技术成熟。</p>
<p>根本原因：纸币受到国家的影响太大。</p>
</blockquote>
<h4 id="中本聪">中本聪</h4>
<ul>
<li>
<p>2008年11月1日，中本聪在&quot;密码朋克&quot;题为《比特币:一种点对点式的电子现金系统》的论文，也就是我们所说的白皮书预览。</p>
</li>
<li>
<p>2009年1月3日发布了第一个版本的比特币客户端，获得了第一批的50个比特币，这标志着比特币金融体系的正式诞生。</p>
</li>
</ul>
<h4 id="中心化和去中心化">中心化和去中心化</h4>
<h5 id="中心化存在的问题">中心化存在的问题</h5>
<p>单点故障问题</p>
<h5 id="去中心化">去中心化</h5>
<p>平等、互联</p>
<p>==比特币是一个具有转账支付功能的去中心化系统==</p>
<h4 id="比特币客户端">比特币客户端</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/f97c38d0972d97fce6531b22cdbd86a6-%E6%AF%94%E7%89%B9%E5%B8%81%E5%AE%A2%E6%88%B7%E7%AB%AF-f669d0.png"
                      alt=""
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/9fee82541b8baf4e8ba025c44cb69910-bitcoin%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D-09639f.png"
                      alt=""
                ></p>
<h2 id="二、比特币简介">二、比特币简介</h2>
<blockquote>
<h4 id="概述">概述</h4>
<p>比特币系统就是一个软件系统，每个人都可以下载使用，使用者之间不断进行交易而产生交易数据，这些数据以数据块的形式保存，最终存储在一个数据库中，这个包含了交易数据的数据块我们叫做区块，这个保存所有区块的数据库我们叫做区块链</p>
<p>==交易产生数据，数据存储再数据库中，它有自己的存储结构，这个数据块叫做区块==</p>
<p>==将所有的区块按照这个区块的哈希链接起来的链条就叫做区块链==</p>
</blockquote>
<h3 id="比特币的记账方式">比特币的记账方式</h3>
<blockquote>
<p>比特币系统规定一个数据块的大小上限为1M，一个数据块就是一个区块</p>
<p>后一个区块里面存储前一个区块的<code>哈希值</code>（由区块本身做哈希生成的)，我们就说后一个区块指向前区块（逻辑上的链接)</p>
<p><font color="red">注：</font>实际上是对区块头做哈希值,这里为了便于理解,后面详细介绍</p>
</blockquote>
<h3 id="基础概念">基础概念</h3>
<h4 id="钱包">钱包</h4>
<blockquote>
<h4 id="创建公钥、私钥，保存私钥，相当于钱包，可以存放多个地址">创建公钥、私钥，保存私钥，相当于钱包，可以存放多个地址</h4>
<p>地址：类似于钱包中不同的银行卡号  ==由公钥生成，并可以由私钥解开==</p>
<p>私钥：类似于每张银行卡有一个密码</p>
<p>wallet.dat 是真正的钱包，负责维护私钥和地址，但是一般把维护这个钱包的客户端统称为钱包</p>
<p>比特币转账每次都会自动生成新的地址，从而隐藏自己的资产</p>
<p>wallet.dat 会自动维护地址和私钥，保存好这个文件即可（如果有密码，一定要记住）</p>
<p>助记词（12个英文单词）</p>
</blockquote>
<h4 id="节点">节点</h4>
<blockquote>
<h4 id="每一个运行挖矿软件的人变成为一个区块链网络的节点">每一个运行挖矿软件的人变成为一个区块链网络的节点</h4>
<ul>
<li>轻节点    ==不下载所有的账本，只下载区块头，和自己有关的交易==</li>
<li>全节点    ==强调是全指的是账本，查看当前总容量==</li>
</ul>
</blockquote>
<h4 id="账本">账本</h4>
<blockquote>
<p>所有交易信息的集合，使用 levelDB 数据库，每个节点都同步一个账本</p>
</blockquote>
<h4 id="挖矿">挖矿</h4>
<blockquote>
<h4 id="三个问题">三个问题</h4>
<ol>
<li>谁负责记账</li>
<li>记账者有什么好处</li>
<li>对于系统来说有什么好处（发行货币、安全且一致）</li>
</ol>
</blockquote>
<ul>
<li>
<p>节点间竞争记账权利的过程就叫做挖矿，竞争成功者获得记账的权利，即挖到矿。</p>
</li>
<li>
<p>每个人都想挖金矿，每个人都想挖比特币。但是有门槛，挖真实的需要有权限，有设备；挖比特币不需要权限，只需要有设备，有电力，但是全世界的一起挖，竟争激烈。</p>
</li>
<li>
<p>记账的过程会得到系统给的奖励。</p>
</li>
<li>
<p>这个过程类似于从一座矿山里从无到有的采集矿石，所以叫做挖矿。挖矿过程就是比特币货币发行过程。</p>
</li>
<li>
<p>挖矿保证了系统的安全,公平的,不确定的。</p>
</li>
<li>
<p>每一个全节点都可以进行挖矿，成为矿工，挖矿的能力叫做算力。</p>
</li>
<li>
<p>==本质：对区块数据做哈希运算,寻找一个满足条件的随机数。==</p>
</li>
</ul>
<h6 id="挖矿本质">挖矿本质</h6>
<p><code>现有的区块数据 + 随机数</code> sha256取哈希，得到的值 &lt; <code>目标哈希</code></p>
<h6 id="难度值">难度值</h6>
<p>难度值由系统统计前2016个区块产生的平均时间来调节，主要是为了保证10分钟作用出块</p>
<h3 id="系统参数">系统参数</h3>
<h4 id="出块时间">出块时间</h4>
<blockquote>
<p>10 分钟左右，系统根据当前出块时间动态调整难度值（每2016个块调整依次，2周），使得时间稳定在 10 分钟左右</p>
<p>包括同步时间、校验时间、计算时间等</p>
<p>如果不控制每 10 分钟 产生一个区块，那么比特币就不能保证稳定的发行，秩序就会混乱</p>
<p>安全性和适用性的权衡，太快容易同时出块，需要频繁的处理，太慢就影响使用体验</p>
</blockquote>
<h4 id="比特币总量">比特币总量</h4>
<blockquote>
<h4 id="出块奖励初始值为-50，每挖出21万个区块就减半一次">出块奖励初始值为 50，每挖出21万个区块就减半一次</h4>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// totalBtc.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> blockInterval = <span class="number">21</span> <span class="comment">// 区块衰减区间， 万</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	total := <span class="number">0.0</span>   <span class="comment">// 总量</span></span><br><span class="line">	reward := <span class="number">50.0</span> <span class="comment">// 最初奖励</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> reward &gt; <span class="number">0</span> &#123;</span><br><span class="line">		amount := reward * blockInterval <span class="comment">// 在21万个块中产生的比特币数量</span></span><br><span class="line">		total += amount</span><br><span class="line"></span><br><span class="line">		reward *= <span class="number">0.5</span> <span class="comment">// 比特币奖励衰减一半，除法效率低</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;total Bitcoin: %f 万个\n&quot;</span>, total) <span class="comment">// 2100.000000 万个</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="区块容量">区块容量</h4>
<blockquote>
<h4 id="考虑同步效率">考虑同步效率</h4>
<p>1M 大约可容纳 4000 条交易（已经扩容）</p>
<p>1M / 每笔交易的字节数 = 交易条数 （1024*1024 / 223 = 4200）</p>
</blockquote>
<h4 id="每秒成交量">每秒成交量</h4>
<blockquote>
<p>4200 / 600 = 7 笔 / 秒</p>
</blockquote>
<h4 id="单位">单位</h4>
<blockquote>
<p>1 BTC = 10 ** 8  sat（聪）</p>
</blockquote>
<h3 id="比特币转账流程">比特币转账流程</h3>
<blockquote>
<p>交易是一切数据的来源</p>
<p>节点中的交易不一定都相同</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/116b6fc119f10c40fafa202a0303b24d-%E6%AF%94%E7%89%B9%E5%B8%81%E8%BD%AC%E8%B4%A6%E6%B5%81%E7%A8%8B-a92415.png"
                      alt=""
                ></p>
<h3 id="比特币依赖技术">比特币依赖技术</h3>
<h4 id="密码学">密码学</h4>
<h5 id="对称加密">对称加密</h5>
<blockquote>
<h4 id="采用单钥密码系统的加密方法，同一个密钥可以同时用作信息的加密和解密，这种加密方法称为对称加密，也称为单密钥加密">采用单钥密码系统的加密方法，同一个密钥可以同时用作信息的加密和解密，这种加密方法称为对称加密，也称为单密钥加密</h4>
</blockquote>
<h6 id="算法">算法</h6>
<p>DES、3DES、AES、TDEA、Blowfish、RC2、RC4、RC5、IDEA、SKIPJACK</p>
<h6 id="特点">特点</h6>
<ul>
<li>
<p>加解密使用相同秘钥</p>
</li>
<li>
<p>高效，适用于大量数据的加密场景</p>
</li>
<li>
<p>算法公开，安全性取决于秘钥大小，但秘钥越大效率越低，需要权衡在安全和效率中做权衡</p>
</li>
<li>
<p>如果是被盗就没办法了(秘钥大难破解)</p>
</li>
</ul>
<h5 id="非对称加密">非对称加密</h5>
<blockquote>
<h4 id="公钥私钥一一对应，公钥负责加密，对外公开，私钥用于加密和签名，仅自己持有，决不能外漏">公钥私钥一一对应，公钥负责加密，对外公开，私钥用于加密和签名，仅自己持有，决不能外漏</h4>
<p>组成</p>
<ul>
<li>公钥：加密、保护隐私</li>
<li>私钥：签名、保证数据来源、保证数据未被篡改、签名人无法否认</li>
</ul>
</blockquote>
<h6 id="特点-2">特点</h6>
<ul>
<li>安全性高</li>
<li>加、解密复杂，效率低</li>
</ul>
<h6 id="算法-2">算法</h6>
<p>RSA、ECC、Elgamal、背包算法、Rabin、D-H</p>
<h4 id="P2P网络">P2P网络</h4>
<blockquote>
<h4 id="P2P-peer-to-peer-点对点技术，无中心服务器，依靠用户群交换信息的互联网体系">P2P(peer-to-peer):点对点技术，无中心服务器，依靠用户群交换信息的互联网体系</h4>
<ul>
<li>
<p>网络的参与者共享他们所拥有的一部分硬件资源（处理能力、存储能力、网络连接能力、打印机等)，这些共享资源通过网络提供服务和内容，能被其它对等节点(Peer)直接访问而无需经过中间实体。</p>
</li>
<li>
<p>在此网络中的参与者既是资源、服务和内容的提供者（Server)，又是资源、服务和内容的获取者（Client）</p>
</li>
<li>
<p>P2P体系结构是应用层概念</p>
</li>
</ul>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/404db40358e02b45a461fe17d9c70903-P2P%E7%BD%91%E7%BB%9C-d9c23b.png"
                      alt=""
                ></p>
<h5 id="特点-3">特点</h5>
<p>耐攻击性、高容错、地位平等</p>
<h4 id="工作量证明">工作量证明</h4>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/68d1c8264e2a64679be9a01870a4dffe-%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E-a37c15.png"
                      style="zoom:50%;" 
                >
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// powDemo.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	data := <span class="string">&quot;hello world&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++ &#123;</span><br><span class="line">		hash := sha256.Sum256([]<span class="type">byte</span>(data + fmt.Sprint(i)))</span><br><span class="line">		fmt.Printf(<span class="string">&quot;hash: %x, nonce: %d\n&quot;</span>, hash, i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run powDemo.go &gt; powDemo.txt</span><br></pre></td></tr></table></figure></div>
<h3 id="比特币地址生成">比特币地址生成</h3>
<blockquote>
<h4 id="对随机字符串进行哈希，生成32字节的私钥">对随机字符串进行哈希，生成32字节的私钥</h4>
<p>地址可以进行校验</p>
<p>比较短、可读</p>
<p>前面有版本号    ==可以根据地址中的版本号迅速判断是属于哪个网络的地址（主网、测试网络、私有网络）==</p>
<p>校验码可用于对地址进行有效性校验</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/0cfce796ecfc6fd14b23150fe2671171-%E6%AF%94%E7%89%B9%E5%B8%81%E5%9C%B0%E5%9D%80%E7%94%9F%E6%88%90%E6%B5%81%E7%A8%8B-1f13dd.png"
                      alt=""
                ></p>
<h3 id="区块结构">区块结构</h3>
<blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/5cb6242161aef467ccc9f5492a9e4d4c-%E5%8C%BA%E5%9D%97%E7%BB%93%E6%9E%84-cdb47b.png"
                      alt=""
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/5ed06c411633aef5120dd1ad88d5a4c3-Block-4b1442.png"
                      alt=""
                ></p>
<p>==比特币的区块大小目前被严格限制在 1MB以内，4字节的区块大小字段不包含在此内==</p>
</blockquote>
<h4 id="区块头">区块头</h4>
<blockquote>
<h5 id="区块不存储-hash-值，节点接收区块后独立计算并存储在本地">区块不存储 hash 值，节点接收区块后独立计算并存储在本地</h5>
</blockquote>
<blockquote>
<h5 id="区块本身不存储当前区块的哈希值，而是节点接收到区块后，在本地自己计算出相应的-hash">区块本身不存储当前区块的哈希值，而是节点接收到区块后，在本地自己计算出相应的 hash</h5>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/1bb86a427bf7d79d2ae60c726be76770-%E5%8C%BA%E5%9D%97%E5%A4%B4-2981af.png"
                      alt=""
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/ab3ffe24061f5de10dd4206dbfd75804-%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BB%93%E6%9E%84-42c52c.png"
                      alt=""
                ></p>
<h4 id="区块体（Transactions）">区块体（Transactions）</h4>
<blockquote>
<h4 id="Coinbase-交易">Coinbase 交易</h4>
<p>第一条交易，挖矿奖励矿工。永远是第一条，没有输入(钱的来源)，只有输出（钱的流向)</p>
</blockquote>
<blockquote>
<h4 id="普通转账交易">普通转账交易</h4>
<p>有输入，也有输出，每笔交易包括付款方、收款方、付款金、手续费等</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/df41b1fd3d63a6c98a76ec3439384f70-%E5%8C%BA%E5%9D%97%E4%BD%93-675600.png"
                      alt=""
                ></p>
<p>input：输入，表示币的来源</p>
<p>output：输出，表示币的流向</p>
<h2 id="三、代码实现">三、代码实现</h2>
<h3 id="v1-版本">v1 版本</h3>
<blockquote>
<h4 id="该版本存在的问题">该版本存在的问题</h4>
<ul>
<li>随机数和难度值是随便写的</li>
<li>区块的哈希值是无规则的</li>
</ul>
</blockquote>
<h4 id="定义区块，创建区块，打印区块">定义区块，创建区块，打印区块</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.定义结构</span></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">	PrevBlockHash []<span class="type">byte</span> <span class="comment">// a.前区块哈希</span></span><br><span class="line">	Hash          []<span class="type">byte</span> <span class="comment">// b.当前区块哈希</span></span><br><span class="line">	Data          []<span class="type">byte</span> <span class="comment">// c.数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建区块，对Block的每一个字段进行填充</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlock</span><span class="params">(data <span class="type">string</span>, prevBlockHash []<span class="type">byte</span>)</span></span> *Block &#123;</span><br><span class="line"></span><br><span class="line">	block := Block&#123;</span><br><span class="line">		PrevBlockHash: prevBlockHash,</span><br><span class="line">		Hash:          []<span class="type">byte</span>&#123;&#125;,</span><br><span class="line">		Data:          []<span class="type">byte</span>(data),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.生成哈希</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.引入区块链</span></span><br><span class="line"><span class="comment">// 5.添加区块</span></span><br><span class="line"><span class="comment">// 6.重构代码</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	block := NewBlock(</span><br><span class="line">		<span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">		[]<span class="type">byte</span>&#123;<span class="number">0x0000000000000000</span>&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;PrevBlockHash: %x\n&quot;</span>, block.PrevBlockHash)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="实现-setHash-函数">实现 setHash 函数</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.生成哈希(无随机值)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(block *Block)</span></span> setHash() &#123;</span><br><span class="line">	<span class="keyword">var</span> data []<span class="type">byte</span></span><br><span class="line">	data = <span class="built_in">append</span>(data, block.PrevBlockHash...)</span><br><span class="line">	data = <span class="built_in">append</span>(data, block.Data...)</span><br><span class="line"></span><br><span class="line">	hash <span class="comment">/* [32]byte */</span> := sha256.Sum256(data)</span><br><span class="line">	block.Hash = hash[:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/9db97db5b80306dc85536d61ec98495f-setHash%E5%87%BD%E6%95%B0-5afe21.png"
                      alt=""
                ></p>
<h4 id="区块链的定义及使用">区块链的定义及使用</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4.引入区块链,使用Block数组模拟</span></span><br><span class="line"><span class="keyword">type</span> BlockChain <span class="keyword">struct</span> &#123;</span><br><span class="line">	Blocks []*Block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建区块链方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockChain</span><span class="params">()</span></span> *BlockChain &#123;</span><br><span class="line">	<span class="comment">// 在创建的时候添加一个区块， 创世块</span></span><br><span class="line">	genesisBlock := NewBlock(</span><br><span class="line">		<span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">		[]<span class="type">byte</span>&#123;<span class="number">0x0000000000000000</span>&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	bc := BlockChain&#123;[]*Block&#123;genesisBlock&#125;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;bc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.添加区块</span></span><br><span class="line"><span class="comment">// 6.重构代码</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	block := NewBlock(</span><br><span class="line">		<span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">		[]<span class="type">byte</span>&#123;<span class="number">0x0000000000000000</span>&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	bc := NewBlockChain()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 遍历打印所有的区块</span></span><br><span class="line">	<span class="keyword">for</span> _, block := <span class="keyword">range</span> bc.Blocks &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;PrevBlockHash: %x\n&quot;</span>, block.PrevBlockHash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="添加区块">添加区块</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.添加区块</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> AddBlock(data <span class="type">string</span>) &#123;</span><br><span class="line">	<span class="comment">// a.创建区块</span></span><br><span class="line">	<span class="comment">// 获取 bc.Blocks的最后一个区块的Hash值就是当前区块的 PrevBlockHash</span></span><br><span class="line">	lastBlock := bc.Blocks[<span class="built_in">len</span>(bc.Blocks)<span class="number">-1</span>]</span><br><span class="line">	block := NewBlock(data, lastBlock.Hash)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// b.添加区块至bc.Blocks数组中</span></span><br><span class="line">	bc.Blocks = <span class="built_in">append</span>(bc.Blocks, block)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="代码重构">代码重构</h4>
<ul>
<li>添加 <code>block.go</code> 文件</li>
<li>添加 <code>blockChain.go</code> 文件</li>
</ul>
<h4 id="补充区块字段">补充区块字段</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.定义结构</span></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">	Version       <span class="type">uint64</span> <span class="comment">// 区块版本号</span></span><br><span class="line">	PrevBlockHash []<span class="type">byte</span> <span class="comment">// 前区块哈希</span></span><br><span class="line">	MerKleRoot    []<span class="type">byte</span> <span class="comment">// 默克尔根</span></span><br><span class="line">	TimeStamp     <span class="type">uint64</span> <span class="comment">// 时间戳，从1970年1月1日至今的秒数</span></span><br><span class="line">	Difficulity   <span class="type">uint64</span> <span class="comment">// 挖矿难度</span></span><br><span class="line">	Nonce         <span class="type">uint64</span> <span class="comment">// 随机数</span></span><br><span class="line">	Data          []<span class="type">byte</span> <span class="comment">// 数据</span></span><br><span class="line">	Hash          []<span class="type">byte</span> <span class="comment">// 当前区块哈希，区块中本不存在的字段，为了方便而添加</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="更新-NewBlock-函数">更新 NewBlock 函数</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.创建区块，对Block的每一个字段进行填充</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlock</span><span class="params">(data <span class="type">string</span>, prevBlockHash []<span class="type">byte</span>)</span></span> *Block &#123;</span><br><span class="line"></span><br><span class="line">	block := Block&#123;</span><br><span class="line">		Version:       <span class="number">00</span>,</span><br><span class="line">		PrevBlockHash: prevBlockHash,</span><br><span class="line">		MerKleRoot:    []<span class="type">byte</span>&#123;&#125;,</span><br><span class="line">		TimeStamp:     <span class="type">uint64</span>(time.Now().Unix()),</span><br><span class="line">		Difficulity:   <span class="number">10</span>, <span class="comment">// 后续会调整</span></span><br><span class="line">		Nonce:         <span class="number">10</span>, <span class="comment">// 后续会调整</span></span><br><span class="line">		Hash:          []<span class="type">byte</span>&#123;&#125;,</span><br><span class="line">		Data:          []<span class="type">byte</span>(data),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	block.setHash()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;block</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="更新-setHash-函数">更新 setHash 函数</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(block *Block)</span></span> setHash() &#123;</span><br><span class="line">	<span class="keyword">var</span> data []<span class="type">byte</span></span><br><span class="line">	<span class="comment">// uintToByte() 将数字转换成 []byte&#123;&#125;,在utils.go中实现</span></span><br><span class="line">	data = <span class="built_in">append</span>(data, uintToByte(block.Version)...)</span><br><span class="line">	data = <span class="built_in">append</span>(data, block.PrevBlockHash...)</span><br><span class="line">	data = <span class="built_in">append</span>(data, block.MerKleRoot...)</span><br><span class="line">	data = <span class="built_in">append</span>(data, uintToByte(block.TimeStamp)...)</span><br><span class="line">	data = <span class="built_in">append</span>(data, uintToByte(block.Difficulity)...)</span><br><span class="line">	data = <span class="built_in">append</span>(data, uintToByte(block.Nonce)...)</span><br><span class="line">	data = <span class="built_in">append</span>(data, block.Data...)</span><br><span class="line"></span><br><span class="line">	hash <span class="comment">/* [32]byte */</span> := sha256.Sum256(data)</span><br><span class="line">	block.Hash = hash[:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="添加空函数-uintToByte">添加空函数 uintToByte</h4>
<blockquote>
<h5 id="在工具文件utils-go中添加">在工具文件<code>utils.go</code>中添加</h5>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 工具函数文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">uintToByte</span><span class="params">(num <span class="type">uint64</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="comment">// 后续补充</span></span><br><span class="line">	<span class="keyword">return</span> []<span class="type">byte</span>&#123;&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="编码逻辑实现">编码逻辑实现</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具函数文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">uintToByte</span><span class="params">(num <span class="type">uint64</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将数据以二进制方式保存到buffer中</span></span><br><span class="line">	<span class="comment">// func Write(w io.Writer, order ByteOrder, data interface&#123;&#125;) error</span></span><br><span class="line">	err := binary.Write(&amp;buffer, binary.BigEndian <span class="comment">/* 大端对齐 */</span>, num)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer.Bytes()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="使用-bytes-join-改写-setHash-函数">使用 bytes.join 改写 setHash 函数</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(block *Block)</span></span> setHash() &#123;</span><br><span class="line">	<span class="keyword">var</span> data []<span class="type">byte</span></span><br><span class="line">	<span class="comment">// uintToByte() 将数字转换成 []byte&#123;&#125;,在utils.go中实现</span></span><br><span class="line">	<span class="comment">// data = append(data, uintToByte(block.Version)...)</span></span><br><span class="line">	<span class="comment">// data = append(data, block.PrevBlockHash...)</span></span><br><span class="line">	<span class="comment">// data = append(data, block.MerKleRoot...)</span></span><br><span class="line">	<span class="comment">// data = append(data, uintToByte(block.TimeStamp)...)</span></span><br><span class="line">	<span class="comment">// data = append(data, uintToByte(block.Difficulity)...)</span></span><br><span class="line">	<span class="comment">// data = append(data, uintToByte(block.Nonce)...)</span></span><br><span class="line">	<span class="comment">// data = append(data, block.Data...)</span></span><br><span class="line"></span><br><span class="line">	tmp := [][]<span class="type">byte</span>&#123;</span><br><span class="line">		uintToByte(block.Version),</span><br><span class="line">		block.PrevBlockHash,</span><br><span class="line">		block.MerKleRoot,</span><br><span class="line">		uintToByte(block.TimeStamp),</span><br><span class="line">		uintToByte(block.Difficulity),</span><br><span class="line">		uintToByte(block.Nonce),</span><br><span class="line">		block.Data,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	data = bytes.Join(tmp, []<span class="type">byte</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	hash <span class="comment">/* [32]byte */</span> := sha256.Sum256(data)</span><br><span class="line">	block.Hash = hash[:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="v2-版本">v2 版本</h3>
<p><a href="./%E8%B5%84%E6%96%99/v2%E7%89%88%E6%9C%AC%E5%AF%BC%E5%9B%BE.xmind">导图</a></p>
<blockquote>
<h4 id="思路">思路</h4>
<ol>
<li><code>POW</code> 介绍
<ul>
<li>定义一个工作量证明的结构 <code>Proof Of Work</code>
<ul>
<li><code>block</code></li>
<li>目标值</li>
</ul>
</li>
</ul>
</li>
<li>提供创建 <code>POW</code> 的函数
<ul>
<li><code>NewProofOfWork(参数)</code></li>
</ul>
</li>
<li>提供不断计算 <code>hash</code> 的函数
<ul>
<li><code>Run()</code></li>
</ul>
</li>
<li>提供一个校验函数
<ul>
<li><code>IsValid()</code></li>
</ul>
</li>
</ol>
</blockquote>
<blockquote>
<h4 id="该版本存在的问题-2">该版本存在的问题</h4>
<ul>
<li>区块在内存中。每次程序执行完就释放，无法重用</li>
<li>创建区块不灵活。再 main 函数中写死，不能随意添加区块</li>
</ul>
</blockquote>
<h4 id="POW-定义">POW 定义</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.定义一个工作量证明的结构 ProofOfWork</span></span><br><span class="line"><span class="keyword">type</span> ProofOfWork <span class="keyword">struct</span> &#123;</span><br><span class="line">	block *Block <span class="comment">// block</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 存储哈希值，内置一了些方法</span></span><br><span class="line">	<span class="comment">// Cmp: 比较方法</span></span><br><span class="line">	<span class="comment">// SetBytes: 可以将 bytes 转成 big.int 类型</span></span><br><span class="line">	<span class="comment">// SetString: 可以把 string 转成 big.int 类型</span></span><br><span class="line">	target *big.Int <span class="comment">// 目标值,系统提供的，是固定的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 提供创建 POW 的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProofOfWork</span><span class="params">(block *Block)</span></span> *ProofOfWork &#123;</span><br><span class="line">	pow := ProofOfWork&#123;</span><br><span class="line">		block: block,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 难度值，应该是推导出来的，此处简化先固定</span></span><br><span class="line">	<span class="comment">// 0000100000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 16 进制格式的字符串</span></span><br><span class="line">	targetStr := <span class="string">&quot;0000100000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> bigIntTmp big.Int</span><br><span class="line">	bigIntTmp.SetString(targetStr, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">	pow.target = &amp;bigIntTmp</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;pow</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="Run-函数实现">Run 函数实现</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.不断计算 hash 的函数, 获取挖矿的 Nonce,同时返回区块的哈希</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span></span> Run() ([]<span class="type">byte</span>, <span class="type">uint64</span>) &#123;</span><br><span class="line">	<span class="comment">// 声明随机变量</span></span><br><span class="line">	<span class="keyword">var</span> nonce <span class="type">uint64</span></span><br><span class="line">	<span class="comment">// 声明哈希数组</span></span><br><span class="line">	<span class="keyword">var</span> hash [<span class="number">32</span>]<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// 拼接 Block 和 Nonce</span></span><br><span class="line">		data := pow.prepareData(nonce)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// c.sha256</span></span><br><span class="line">		hash <span class="comment">/* 数组类型 */</span> = sha256.Sum256(data)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// d.与难度值比较</span></span><br><span class="line">		<span class="comment">// 将 hash(数组类型) 转成 big.int,然后与 pow.target 进行比较，需要引入局部变量</span></span><br><span class="line">		<span class="keyword">var</span> bigIntTmp big.Int</span><br><span class="line">		bigIntTmp.SetBytes(hash[:])</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 比较</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			func (x *Int) Cmp(y *Int) (r int)</span></span><br><span class="line"><span class="comment">			Cmp compares x and y and returns:</span></span><br><span class="line"><span class="comment">			-1 if x &lt;  y</span></span><br><span class="line"><span class="comment">			0  if x == y</span></span><br><span class="line"><span class="comment">			+1 if x &gt;  y</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		result := bigIntTmp.Cmp(pow.target)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> result == <span class="number">-1</span> &#123;</span><br><span class="line">			<span class="comment">// Ⅰ：若哈希值小于难度值，挖矿成功，退出</span></span><br><span class="line">			fmt.Printf(<span class="string">&quot;挖矿成功！Nonce: %v, hash: %v\n&quot;</span>, nonce, hash)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Ⅱ: 若哈希值大于难度值，nonce ++</span></span><br><span class="line">			nonce++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> hash[:], nonce</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 提供一个校验函数</span></span><br><span class="line"><span class="comment">//     - `IsValid()`</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span></span> prepareData(nonce <span class="type">uint64</span>) []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="comment">// a.获取 block 数据</span></span><br><span class="line">	block := pow.block</span><br><span class="line"></span><br><span class="line">	<span class="comment">// b.拼接 nonce</span></span><br><span class="line">	tmp := [][]<span class="type">byte</span>&#123;</span><br><span class="line">		uintToByte(block.Version),</span><br><span class="line">		block.PrevBlockHash,</span><br><span class="line">		block.MerKleRoot,</span><br><span class="line">		uintToByte(block.TimeStamp),</span><br><span class="line">		uintToByte(block.Difficulity),</span><br><span class="line">		block.Data,</span><br><span class="line">		uintToByte(nonce),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bytes.Join(tmp, []<span class="type">byte</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="使用-pow-更新-NewBlock">使用  pow 更新 NewBlock</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.创建区块，对Block的每一个字段进行填充</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlock</span><span class="params">(data <span class="type">string</span>, prevBlockHash []<span class="type">byte</span>)</span></span> *Block &#123;</span><br><span class="line"></span><br><span class="line">	block := Block&#123;</span><br><span class="line">		Version:       <span class="number">00</span>,</span><br><span class="line">		PrevBlockHash: prevBlockHash,</span><br><span class="line">		MerKleRoot:    []<span class="type">byte</span>&#123;&#125;,</span><br><span class="line">		TimeStamp:     <span class="type">uint64</span>(time.Now().Unix()),</span><br><span class="line">		Difficulity:   <span class="number">10</span>, <span class="comment">// 后续会调整</span></span><br><span class="line">		Nonce:         <span class="number">10</span>, <span class="comment">// 后续会调整</span></span><br><span class="line">		Hash:          []<span class="type">byte</span>&#123;&#125;,</span><br><span class="line">		Data:          []<span class="type">byte</span>(data),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// block.setHash()</span></span><br><span class="line">	pow := NewProofOfWork(&amp;block)</span><br><span class="line">	hash, nonce := pow.Run()</span><br><span class="line">	block.Hash = hash</span><br><span class="line">	block.Nonce = nonce</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;block</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="校验挖矿是否有效">校验挖矿是否有效</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4. 提供一个校验函数</span></span><br><span class="line"><span class="comment">// 在校验的时候，block的数据是完整的，需要做的只是校验一下, hash、block数据和 Nonce 是否满足难度值要求</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span></span> IsValid() <span class="type">bool</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用prepareData函数获取拼接好的数据</span></span><br><span class="line">	data := pow.prepareData(pow.block.Nonce)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// sha256</span></span><br><span class="line">	hash := sha256.Sum256(data)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 比较</span></span><br><span class="line">	<span class="keyword">var</span> temp big.Int</span><br><span class="line">	temp.SetBytes(hash[:])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> temp.Cmp(pow.target) == <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="打印-Block-字段">打印 Block 字段</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	bc := NewBlockChain()</span><br><span class="line">	bc.AddBlock(<span class="string">&quot;I&#x27;m Li Lubo&quot;</span>)</span><br><span class="line">	bc.AddBlock(<span class="string">&quot;I&#x27;m Cai Jinxiao&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 遍历打印所有的区块</span></span><br><span class="line">	<span class="keyword">for</span> i, block := <span class="keyword">range</span> bc.Blocks &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;========================== %d ==========================\n&quot;</span>, i) <span class="comment">// 打印区块高度</span></span><br><span class="line">		fmt.Printf(<span class="string">&quot;Version: %v\n&quot;</span>, block.Version)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;PrevBlockHash: %x\n&quot;</span>, block.PrevBlockHash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;MerkleRoot: %x\n&quot;</span>, block.MerKleRoot)</span><br><span class="line"></span><br><span class="line">		time := time.Unix(<span class="type">int64</span>(block.TimeStamp), <span class="number">0</span>).Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;TimeStamp: %s\n&quot;</span>, time)</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;Difficulity: %d\n&quot;</span>, block.Difficulity)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Nonce: %d\n&quot;</span>, block.Nonce)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line"></span><br><span class="line">		pow := NewProofOfWork(block)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;IsValid: %v\n&quot;</span>, pow.IsValid())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="使用-Bits-推导难度值">使用 Bits 推导难度值</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 位数</span></span><br><span class="line"><span class="comment">// 难度值的零 20/4 - 1 个</span></span><br><span class="line"><span class="comment">// 求出哈希的零 20/4 个</span></span><br><span class="line"><span class="keyword">const</span> BITS = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建 POW 的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProofOfWork</span><span class="params">(block *Block)</span></span> *ProofOfWork &#123;</span><br><span class="line">	pow := ProofOfWork&#123;</span><br><span class="line">		block: block,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 固定的难度值 */</span></span><br><span class="line">	<span class="comment">/* // 难度值，应该是推导出来的，此处简化先固定</span></span><br><span class="line"><span class="comment">	// 0001000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	// 16 进制格式的字符串</span></span><br><span class="line"><span class="comment">	targetStr := &quot;0001000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	var bigIntTmp big.Int</span></span><br><span class="line"><span class="comment">	bigIntTmp.SetString(targetStr, 16)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	pow.target = &amp;bigIntTmp */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 推导难度值 */</span></span><br><span class="line">	<span class="comment">// 前导为3个零的难度值  即：0001000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line">	bigIntTmp := big.NewInt(<span class="number">1</span>) <span class="comment">// 0000000000000000000000000000000000000000000000000000000000000001</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 先向做移动 256位，再向右移动 16位</span></span><br><span class="line">	<span class="comment">// 十六进制的 1位相当于二进制的 4位</span></span><br><span class="line">	<span class="comment">// bigIntTmp.Lsh(bigIntTmp, 256) // 1 0000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line">	<span class="comment">// bigIntTmp.Rsh(bigIntTmp, 16)  // 0 0001000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line">	pow.target = bigIntTmp.Lsh(bigIntTmp, <span class="number">256</span>-BITS) <span class="comment">// 0001000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;pow</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="v3-版本">v3 版本</h3>
<p><a href="./%E8%B5%84%E6%96%99/v3%E7%89%88%E6%9C%AC%E5%AF%BC%E5%9B%BE.xmind">导图</a></p>
<blockquote>
<h4 id="思路-2">思路</h4>
<ol>
<li>bolt数据库介绍
<ul>
<li>轻量级的、开源的</li>
<li>go语言实现的</li>
<li><code>key</code>、<code>value</code> 进行读取</li>
</ul>
</li>
<li><code>BlockChain</code>  结构进行重写
<ul>
<li>使用数据库替代数组</li>
</ul>
</li>
<li><code>NewBlockChain</code> 函数重写
<ul>
<li>由对数组操作改写成对数据库操作，创建数据库</li>
</ul>
</li>
<li><code>AddBlock</code> 函数重写
<ul>
<li>对数据库的读取和打印</li>
</ul>
</li>
<li>打印数据
<ul>
<li>对数据库的遍历（迭代器<code>iterator</code>）</li>
</ul>
</li>
<li>命令行
<ul>
<li>命令行介绍即编写</li>
<li>添加区块命令</li>
<li>打印区块链命令</li>
<li>创建区块链</li>
</ul>
</li>
</ol>
</blockquote>
<h4 id="bolt-数据库">bolt 数据库</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/1b8dbb2fe6258364c9530aaba0a66d63-blot%E6%95%B0%E6%8D%AE%E5%BA%93-25d986.png"
                      alt=""
                ></p>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// boltDemo.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/boltdb/bolt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    法1：</span></span><br><span class="line"><span class="comment">		go mod init Demo</span></span><br><span class="line"><span class="comment">		go mod tidy</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	db, err := bolt.Open(<span class="string">&quot;test.db&quot;</span>, <span class="number">0600</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">	db.Update(<span class="function"><span class="keyword">func</span><span class="params">(t *bolt.Tx)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="comment">// 所有的操作都在这里</span></span><br><span class="line">		<span class="comment">// 1.创建bucket</span></span><br><span class="line">		b1 := t.Bucket([]<span class="type">byte</span>(<span class="string">&quot;bucketName1&quot;</span>))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> b1 == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// 如果 b1为空，说明名字为&quot;bucketName1&quot;的这个桶不存在，需要创建</span></span><br><span class="line">			b1, err = t.CreateBucket([]<span class="type">byte</span>(<span class="string">&quot;bucketName1&quot;</span>))</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Panic(err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 写数据，使用put</span></span><br><span class="line">		<span class="comment">// func (b *Bucket) Put(key []byte, value []byte) error</span></span><br><span class="line">		err = b1.Put([]<span class="type">byte</span>(<span class="string">&quot;name1&quot;</span>), []<span class="type">byte</span>(<span class="string">&quot;lubo&quot;</span>))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;写入数据失败err: %s\n&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = b1.Put([]<span class="type">byte</span>(<span class="string">&quot;name2&quot;</span>), []<span class="type">byte</span>(<span class="string">&quot;jinxiao&quot;</span>))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;写入数据失败err: %s\n&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 读数据，使用Get</span></span><br><span class="line">		name1 := b1.Get([]<span class="type">byte</span>(<span class="string">&quot;name1&quot;</span>))</span><br><span class="line">		name2 := b1.Get([]<span class="type">byte</span>(<span class="string">&quot;name2&quot;</span>))</span><br><span class="line">		name3 := b1.Get([]<span class="type">byte</span>(<span class="string">&quot;name3&quot;</span>))</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;name1: %s\n&quot;</span>, name1)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;name2: %s\n&quot;</span>, name2)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;name3: %s\n&quot;</span>, name3)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="分析-Bolt-存储区块的格式">分析 Bolt 存储区块的格式</h4>
<blockquote>
<h4 id="Bolt-数据库在区块链中的使用"><code>Bolt</code> 数据库在区块链中的使用</h4>
<ul>
<li>
<p><code>key</code> 值是唯一的</p>
</li>
<li>
<p>所有的区块存储在一个 <code>bucket</code> 中<code>(Key：Value)</code>，区块 <code>Hash</code> 作为 <code>key</code>，区块的字节流作为 <code>value</code></p>
</li>
<li>
<p>在 <code>bucket</code> 中存储两种数据</p>
<ul>
<li>
<p>区块。区块的哈希值作为 <code>key</code>，区块的字节流作为 <code>value</code></p>
</li>
<li>
<p>最后一个区块的哈希值。<code>key</code> 使用固定的字符串<code>[]byte(&quot;lastHashKey&quot;): 最后一个区块的 Hash</code></p>
  <div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key 使用固定的字符串</span></span><br><span class="line">[]<span class="type">byte</span>(<span class="string">&quot;lastHashKey&quot;</span>): 最后一个区块的 Hash</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</li>
<li>
<p>存储格式：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/bef2f120f072611f86dffb68bf459151-%E5%8C%BA%E5%9D%97%E5%9C%A8Bolt%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F-5e7693.png"
                      alt=""
                ></p>
</li>
</ul>
</blockquote>
<blockquote>
<h3 id="结论">结论</h3>
<p>==添加一个区块要做的两件事：==</p>
<ul>
<li>添加区块</li>
<li>更新 <code>lastHashKey</code> 这个 <code>key</code> 对于的值，该值就是最后一个区块的哈希值，用于新区块的创建、添加</li>
</ul>
</blockquote>
<h4 id="改写区块链-NewBlockChain-方法">改写区块链 NewBlockChain 方法</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建区块链方法</span></span><br><span class="line"><span class="comment">// 区块链不存在，则创建，若存在则返回区块链实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockChain</span><span class="params">()</span></span> *BlockChain &#123;</span><br><span class="line">	<span class="comment">// 1.获取数据库句柄，打开数据库，读写数据</span></span><br><span class="line">	db, err := bolt.Open(<span class="string">&quot;blockChain.db&quot;</span>, <span class="number">0600</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> tail []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	db.Update(<span class="function"><span class="keyword">func</span><span class="params">(t *bolt.Tx)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="comment">// 准备bucket</span></span><br><span class="line">		bucket := t.Bucket([]<span class="type">byte</span>(<span class="string">&quot;blockBucket&quot;</span>))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> bucket == <span class="literal">nil</span> &#123;</span><br><span class="line">			bucket, err = t.CreateBucket([]<span class="type">byte</span>(<span class="string">&quot;blockBucket&quot;</span>))</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Panic(err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 添加创世块</span></span><br><span class="line">			genesisBlock := NewBlock(</span><br><span class="line">				<span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">				[]<span class="type">byte</span>&#123;&#125;,</span><br><span class="line">			)</span><br><span class="line"></span><br><span class="line">			bucket.Put(genesisBlock.Hash, genesisBlock.toBytes() <span class="comment">/* 将区块序列化，转为字节流 */</span>)</span><br><span class="line">			bucket.Put([]<span class="type">byte</span>(<span class="string">&quot;lastHashKey&quot;</span>), genesisBlock.Hash)</span><br><span class="line"></span><br><span class="line">			tail = genesisBlock.Hash</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			tail = bucket.Get([]<span class="type">byte</span>(<span class="string">&quot;lastHashKey&quot;</span>))</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;BlockChain&#123;db, tail&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="gob-编解码">gob 编解码</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  gobDemo.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/gob&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.gob 是go语言内置的编码包</span></span><br><span class="line"><span class="comment">// 2.它可以对任意类型的数据进行编码和解码</span></span><br><span class="line"><span class="comment">// 3.编码是先要创建编码器，由编码器进行编码</span></span><br><span class="line"><span class="comment">// 4.解码是先要创建解码器，由解码器进行解码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age  <span class="type">uint64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lubo := Person&#123;<span class="string">&quot;lubo&quot;</span>, <span class="number">19</span>&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义编码器</span></span><br><span class="line">	encoder := gob.NewEncoder(&amp;buffer)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 编码及校验，编码成功数据存于buffer中</span></span><br><span class="line">	err := encoder.Encode(&amp;lubo)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;编码后的数据： %x\n&quot;</span>, buffer.Bytes())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解码，将字节流转换成Person结构</span></span><br><span class="line">	<span class="keyword">var</span> p Person</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义解码器</span></span><br><span class="line">	decoder := gob.NewDecoder(bytes.NewReader(buffer.Bytes()))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解码及校验</span></span><br><span class="line">	err = decoder.Decode(&amp;p)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;解码后的数据： %v\n&quot;</span>, p)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="编码、解码">编码、解码</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 序列化，将区块转换成字节流</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(block *Block)</span></span> serialize() []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义编码器</span></span><br><span class="line">	encoder := gob.NewEncoder(&amp;buffer)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 编码</span></span><br><span class="line">	err := encoder.Encode(block)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer.Bytes()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化，将字节流转换成区块</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeSerialize</span><span class="params">(data []<span class="type">byte</span>)</span></span> *Block &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;解码传入的数据: %x\n&quot;</span>, data)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> block Block</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义解码器</span></span><br><span class="line">	decoder := gob.NewDecoder(bytes.NewReader(data))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解码</span></span><br><span class="line">	err := decoder.Decode(&amp;block)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;block</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="更新-AddBlock">更新 AddBlock</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.添加区块</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> AddBlock(data <span class="type">string</span>) &#123;</span><br><span class="line">	bc.db.Update(<span class="function"><span class="keyword">func</span><span class="params">(t *bolt.Tx)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		bucket := t.Bucket([]<span class="type">byte</span>(<span class="string">&quot;blockChain&quot;</span>))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> bucket == <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;bucket不存在，请检查！\n&quot;</span>)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		newBlock := NewBlock(data, bc.tail)</span><br><span class="line">		bucket.Put(newBlock.Hash, newBlock.serialize())</span><br><span class="line">		bucket.Put([]<span class="type">byte</span>(<span class="string">&quot;lastHashKey&quot;</span>), newBlock.Hash)</span><br><span class="line"></span><br><span class="line">		bc.tail = newBlock.Hash</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="迭代器">迭代器</h4>
<blockquote>
<h4 id="功能分析">功能分析</h4>
<p>创建一个 <code>BlockChain</code> 的迭代器，里面包含两个元素，<code>db</code>、<code>current</code></p>
<p><code>db</code>：为了遍历账本</p>
<p><code>current</code>：为了访问每个区块</p>
<p><code>Next()</code>：</p>
<ul>
<li>
<p>返回当前所指向的区块数据</p>
</li>
<li>
<p>指针向前移动</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/1a68f929875cd6ee51bac497f70a1acc-%E8%BF%AD%E4%BB%A3%E5%99%A8%E7%A4%BA%E6%84%8F%E5%9B%BE-5d5aa2.png"
                      alt=""
                ></p>
</li>
</ul>
</blockquote>
<h4 id="定义、创建迭代器">定义、创建迭代器</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义区块链迭代器</span></span><br><span class="line"><span class="keyword">type</span> BlockChainIterator <span class="keyword">struct</span> &#123;</span><br><span class="line">	db *bolt.DB</span><br><span class="line">	current []<span class="type">byte</span> <span class="comment">// 当前所指向的区块的哈希值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建迭代器，使用bc进行初始化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> NewIterator() *BlockChainIterator &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;BlockChainIterator&#123;bc.db, bc.tail&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="迭代器-Next-函数实现">迭代器 Next 函数实现</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(it *BlockChainIterator)</span></span> Next() *Block &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> block Block</span><br><span class="line"></span><br><span class="line">	it.db.View(<span class="function"><span class="keyword">func</span><span class="params">(t *bolt.Tx)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">		bucket := t.Bucket([]<span class="type">byte</span>(blockBucketName))</span><br><span class="line">		<span class="keyword">if</span> bucket == <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;bucket不存在，请检查！\n&quot;</span>)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 读取数据</span></span><br><span class="line">		blockInfo <span class="comment">/* 字节流 */</span> := bucket.Get(it.current)</span><br><span class="line">		block = *DeSerialize(blockInfo)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 当前所指哈希向前移动</span></span><br><span class="line">		it.current = block.PrevBlockHash</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;block</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="使用迭代器更新-main-函数">使用迭代器更新 main 函数</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	bc := NewBlockChain()</span><br><span class="line">	<span class="keyword">defer</span> bc.db.Close() <span class="comment">// 关闭db</span></span><br><span class="line"></span><br><span class="line">	bc.AddBlock(<span class="string">&quot;I&#x27;m Li Lubo&quot;</span>)</span><br><span class="line">	bc.AddBlock(<span class="string">&quot;I&#x27;m Cai Jinxiao&quot;</span>)</span><br><span class="line"></span><br><span class="line">	it := bc.NewIterator()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := it.Next()</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;====================================================\n&quot;</span>)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Version: %v\n&quot;</span>, block.Version)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;PrevBlockHash: %x\n&quot;</span>, block.PrevBlockHash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;MerkleRoot: %x\n&quot;</span>, block.MerKleRoot)</span><br><span class="line"></span><br><span class="line">		time := time.Unix(<span class="type">int64</span>(block.TimeStamp), <span class="number">0</span>).Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;TimeStamp: %s\n&quot;</span>, time)</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;Difficulity: %d\n&quot;</span>, block.Difficulity)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Nonce: %d\n&quot;</span>, block.Nonce)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line"></span><br><span class="line">		pow := NewProofOfWork(block)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;IsValid: %v\n&quot;</span>, pow.IsValid())</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> bytes.Equal(block.PrevBlockHash, []<span class="type">byte</span>&#123;&#125;) &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;区块链遍历结束！\n&quot;</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="命令行-Demo">命令行 Demo</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// osArgsDemo.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cmds := os.Args</span><br><span class="line"></span><br><span class="line">	<span class="comment">// go build .\osArgsDemo.go</span></span><br><span class="line">	<span class="comment">// .\osArgsDemo.exe hello world</span></span><br><span class="line">	<span class="comment">// cmd[0]: C:\Users\lubo\Desktop\bitcoin\Demo\osArgsDemo.exe</span></span><br><span class="line">	<span class="comment">// cmd[1]: hello</span></span><br><span class="line">	<span class="comment">// cmd[2]: world</span></span><br><span class="line">	<span class="keyword">for</span> i, cmd := <span class="keyword">range</span> cmds &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;cmd[%d]: %s\n&quot;</span>, i, cmd)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="使用命令行分析">使用命令行分析</h4>
<blockquote>
<h4 id="命令行分析">命令行分析</h4>
<ol>
<li>
<p>所有的支配动作交给命令行来做</p>
</li>
<li>
<p>主函数只需进行调用命令行结构即可</p>
</li>
<li>
<p>根据输入的不同命令，命令行做相应动作</p>
<ul>
<li><code>addBlock</code></li>
<li><code>printChain</code></li>
</ul>
</li>
</ol>
<p><code>CLI</code>：<code>command line</code> 的缩写</p>
<p>添加区块：</p>
<ul>
<li>
<pre><code class="language-go">  bc.addBlock(data) // data通过os.Args获取
  <div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">打印区块链，遍历区块链，不需要外部数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 定义 CLI 结构，实现 Run 方法</span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line">const Usage = `</span><br><span class="line">./blockchain addBlock &quot;xxxx&quot; 添加数据到区块链</span><br><span class="line">./blockchain printchain 	 打印区块链</span><br><span class="line">`</span><br><span class="line"></span><br><span class="line">// 定义CLI结构</span><br><span class="line">type CLI struct &#123;</span><br><span class="line">bc *BlockChain</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 给CLI提供一个方法进行命令解析</span><br><span class="line">func (cli *CLI) Run() &#123;</span><br><span class="line"></span><br><span class="line">cmds := os.Args</span><br><span class="line"></span><br><span class="line">if len(cmds) &lt; 2 &#123;</span><br><span class="line">	fmt.Printf(Usage)</span><br><span class="line">	os.Exit(1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">switch cmds[1] &#123;</span><br><span class="line">case &quot;addblock&quot;:</span><br><span class="line">	fmt.Printf(&quot;添加区块命令被调用，数据： %s\n&quot;, cmds[2])</span><br><span class="line">case &quot;printchain&quot;:</span><br><span class="line">	fmt.Printf(&quot;打印区块链命令被调用\n&quot;)</span><br><span class="line">default:</span><br><span class="line">	fmt.Printf(&quot;无效的命令\n&quot;)</span><br><span class="line">	fmt.Printf(Usage)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</code></pre>
</li>
</ul>
</blockquote>
<h5 id="改写-main-函数">改写 main 函数</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译生成可执行文件：go build -o blockchain.exe block.go blockChain.go ProofOfWork.go utils.go cli.go main.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	bc := NewBlockChain()</span><br><span class="line">	<span class="keyword">defer</span> bc.db.Close() <span class="comment">// 关闭db</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义 CLI</span></span><br><span class="line">	cli := CLI&#123;bc&#125;</span><br><span class="line">	cli.Run()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// bc.AddBlock(&quot;I&#x27;m Li Lubo&quot;)</span></span><br><span class="line">	<span class="comment">// bc.AddBlock(&quot;I&#x27;m Cai Jinxiao&quot;)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// it := bc.NewIterator()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// for &#123;</span></span><br><span class="line">	<span class="comment">// 	block := it.Next()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;====================================================\n&quot;)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;Version: %v\n&quot;, block.Version)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;PrevBlockHash: %x\n&quot;, block.PrevBlockHash)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;MerkleRoot: %x\n&quot;, block.MerKleRoot)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 	time := time.Unix(int64(block.TimeStamp), 0).Format(&quot;2006-01-02 15:04:05&quot;)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;TimeStamp: %s\n&quot;, time)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;Difficulity: %d\n&quot;, block.Difficulity)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;Nonce: %d\n&quot;, block.Nonce)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;Hash: %x\n&quot;, block.Hash)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;Data: %s\n&quot;, block.Data)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 	pow := NewProofOfWork(block)</span></span><br><span class="line">	<span class="comment">// 	fmt.Printf(&quot;IsValid: %v\n&quot;, pow.IsValid())</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 	if bytes.Equal(block.PrevBlockHash, []byte&#123;&#125;) &#123;</span></span><br><span class="line">	<span class="comment">// 		fmt.Printf(&quot;区块链遍历结束！\n&quot;)</span></span><br><span class="line">	<span class="comment">// 		break</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="更新-Run-函数">更新 Run 函数</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给CLI提供一个方法进行命令解析</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> Run() &#123;</span><br><span class="line"></span><br><span class="line">	cmds := os.Args</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cmds) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		fmt.Println(Usage)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> cmds[<span class="number">1</span>] &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;addblock&quot;</span>:</span><br><span class="line">		fmt.Printf(<span class="string">&quot;添加区块命令被调用，数据： %s\n&quot;</span>, cmds[<span class="number">2</span>])</span><br><span class="line">		data := cmds[<span class="number">2</span>]</span><br><span class="line">		cli.addBlock(data)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;printchain&quot;</span>:</span><br><span class="line">		fmt.Printf(<span class="string">&quot;打印区块链命令被调用\n&quot;</span>)</span><br><span class="line">		cli.PrintChain()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		fmt.Printf(<span class="string">&quot;无效的命令\n&quot;</span>)</span><br><span class="line">		fmt.Println(Usage)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="添加-commands-go-文件">添加 commands.go 文件</h4>
<blockquote>
<p>这是实现具体命令的文件</p>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现具体的命令</span></span><br><span class="line"><span class="comment">// 添加区块</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> addBlock(data <span class="type">string</span>) &#123;</span><br><span class="line">	cli.bc.AddBlock(data)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;添加区块成功!\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印区块链</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> PrintChain() &#123;</span><br><span class="line">	it := cli.bc.NewIterator()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := it.Next()</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;====================================================\n&quot;</span>)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Version: %v\n&quot;</span>, block.Version)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;PrevBlockHash: %x\n&quot;</span>, block.PrevBlockHash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;MerkleRoot: %x\n&quot;</span>, block.MerKleRoot)</span><br><span class="line"></span><br><span class="line">		time := time.Unix(<span class="type">int64</span>(block.TimeStamp), <span class="number">0</span>).Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;TimeStamp: %s\n&quot;</span>, time)</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;Difficulity: %d\n&quot;</span>, block.Difficulity)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Nonce: %d\n&quot;</span>, block.Nonce)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line"></span><br><span class="line">		pow := NewProofOfWork(block)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;IsValid: %v\n&quot;</span>, pow.IsValid())</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> bytes.Equal(block.PrevBlockHash, []<span class="type">byte</span>&#123;&#125;) &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;区块链遍历结束！\n&quot;</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="四、交易">四、交易</h2>
<blockquote>
<ul>
<li>银行转账
<ul>
<li>转账成功与否只在乎数据表中的余额字段是否足够，不需要将钱的来源检验一遍</li>
</ul>
</li>
<li>比特币转账
<ul>
<li>比特币的数据库中只有交易，没有用于集中保存用户信息的数据表。</li>
<li>没有地方存储账户，没有地方存储余额</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="手续费">手续费</h3>
<p>大多数交易包含交易费（矿工费)，这是为了确保网络安全而给比特币矿工的一种补偿。费用本身也作为一个安全机制,使经济上不利于攻击者通过交易来淹没网络。</p>
<p>交易费作为矿工打包（挖矿）一笔交易到下一个区块中的一种激励;同时作为一种抑制因素，通过对每一笔交易收取小额费用来防止对系统的滥用。成功挖到某区块的矿工将得到该区内包含的矿工费，并将该区块添加至区块链中。</p>
<p>交易费是基于交易的千字节规模来计算的，而不是比特币交易的价值。</p>
<p>交易的数据结构没有交易费的字段。相替代地，交易费是指输入和输出之间的差值。从所有输入中扣掉所有输出之后的多余的量会被矿工作为矿工费收集走。</p>
<p>交易费即：输入总和减输出总和的余量：</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>交易费</mtext><mo>=</mo><mtext>所有输入之和</mtext><mo>−</mo><mtext>所有输出之和</mtext></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
交易费 = 所有输入之和 - 所有输出之和
\end{align}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5em;vertical-align:-0.5em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1em;"><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord cjk_fallback">交易费</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord cjk_fallback">所有输入之和</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord cjk_fallback">所有输出之和</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1em;"><span style="top:-3em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5em;"><span></span></span></span></span></span></span></span></span></p>
<h3 id="转账">转账</h3>
<h4 id="一对多转账">一对多转账</h4>
<blockquote>
<p>一个输入对应一个输出（忽略找零）</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/a0f4632c0670e7cb6360ba8c08bd2a0a-%E4%B8%80%E5%AF%B9%E4%B8%80%E8%BD%AC%E8%B4%A6-736512.png"
                      alt=""
                ></p>
<h4 id="多对一转账">多对一转账</h4>
<blockquote>
<p>多个输入对应一个输出（忽略找零）</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/c72921b5ac83a24bd8aef9771a25fd20-%E5%A4%9A%E5%AF%B9%E4%B8%80%E8%BD%AC%E8%B4%A6-b2c66f.png"
                      alt=""
                ></p>
<h3 id="比特币中的交易形式">比特币中的交易形式</h3>
<blockquote>
<p>比特币中，没有付款人和收款人，只有输入(input)和输出(output)，每个输入都对应着之前别人给你转账时产生的某个输出</p>
</blockquote>
<h4 id="普通交易（找零）">普通交易（找零）</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/927ddf541579ccdd6ec54965fac92ae3-%E6%99%AE%E9%80%9A%E4%BA%A4%E6%98%93-536613.png"
                      alt=""
                ></p>
<h4 id="多对一（凑零钱付账）">多对一（凑零钱付账）</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/0b439318c33d03204c94bf5a4f115d0a-%E5%A4%9A%E5%AF%B9%E4%B8%80-830da0.png"
                      alt=""
                ></p>
<h4 id="一对多（代发工资）">一对多（代发工资）</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/fb1eeafac6620e3cb10db14068c4d1bc-%E4%B8%80%E5%AF%B9%E5%A4%9A-acfdb3.png"
                      alt=""
                ></p>
<h4 id="多对多（大额支付-找零）">多对多（大额支付+找零）</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/ca1cf32260a26abcd7c57439a85fb4d7-%E5%A4%9A%E5%AF%B9%E5%A4%9A-979260.png"
                      alt=""
                ></p>
<h3 id="交易流程">交易流程</h3>
<h4 id="输出产生流程">输出产生流程</h4>
<blockquote>
<h4 id="转账发起时，比特币系统会生成一个-Output">转账发起时，比特币系统会生成一个 <code>Output</code></h4>
<p><code>Output</code> 中包括：</p>
<ul>
<li>转账金额</li>
<li>一个锁定脚本，使用==接收人==的公钥哈希对转账金额进行锁定</li>
</ul>
<p>==注意点==：</p>
<ul>
<li>是使用接收人的公钥哈希进行锁定，不是地址。地址可以推出公钥哈希</li>
</ul>
</blockquote>
<h4 id="输入产生流程">输入产生流程</h4>
<blockquote>
<h4 id="每一个-input-都源于一个-Output">每一个 <code>input</code> 都源于一个 <code>Output</code></h4>
<p><code>Input</code> 包括：</p>
<ul>
<li>交易<code>Id</code>（<code>Hash</code>，哪一笔交易）</li>
<li><code>Output</code> 索引 （<code>int</code>， 所引用交易中的那个 <code>Output</code>）</li>
<li>支付人的签名（解锁脚本，包括签名和自己的公钥）</li>
</ul>
<p>==注意==：</p>
<ul>
<li>挖矿奖励不需要引用任何 <code>Output</code>，相当于有一个特殊的 <code>Input</code></li>
</ul>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/67850b4929e2455e8f14a5daecede9d2-inputAndOutput-223dba.png"
                      alt=""
                ></p>
<h4 id="校验脚本">校验脚本</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/9e80422fe02bdf0b1b3d6b464232294c-Script-784c28.png"
                      alt=""
                ></p>
<h5 id="锁定脚本">锁定脚本</h5>
<blockquote>
<p>锁定脚本：获取接收人的地址，用接收人的公钥进行锁定</p>
<p>解锁脚本：提供支付人的私钥签名（公钥）</p>
<div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OP_DUP OP_HASH160 &lt;Cafe Public Key Hash&gt; OP_EQUALVERIFY OP_CHECKSIG</span><br></pre></td></tr></table></figure></div>
<p>锁定的过程可以理解为一个函数，输入的参数是收款人的==公钥的哈希==，里边有锁定的逻辑</p>
</blockquote>
<h5 id="解锁脚本">解锁脚本</h5>
<div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;cafe Signature&gt; &lt;cafe Public Key&gt;</span><br></pre></td></tr></table></figure></div>
<h5 id="校验交易">校验交易</h5>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/d2c483b571191cbbce22bd579df4558d-%E4%BA%A4%E6%98%93%E6%A0%A1%E9%AA%8C%E5%9B%BE%E7%A4%BA-7f954d.png"
                      alt=""
                ></p>
<h3 id="UTXO">UTXO</h3>
<blockquote>
<h4 id="未消费输出（UTXO，Unspent-Transaction-Output）">未消费输出（UTXO，Unspent Transaction Output）</h4>
<p>尚未使用的 <code>Output</code></p>
</blockquote>
<blockquote>
<h6 id="UTXO-流程演示-演示"><code>UTXO</code> 流程演示 <a href="./%E8%B5%84%E6%96%99/UTXO%E6%BC%94%E7%A4%BA%E6%B5%81%E7%A8%8B.html">演示</a></h6>
</blockquote>
<ul>
<li><code>UTXO</code> 是比特币交易中 最小的支付单元，不可分割，每一个 <code>UTXO</code> 必须一次性消耗完，然后生成新的 <code>UTXO</code>，存放在比特币网络的UTXO池中</li>
<li><code>UTXO</code> 是不能再分割、被所有者锁住或记录于区块链中的并被整个网络识别成货币单位的一定量的比特币货币</li>
<li>比特币网络监测着以百万为单位的所有可用的(未花费的) <code>UTXO</code>。当一个用户接收比特币时，金额被当作 <code>UTXO</code> 记录到区块链里。这样，一个用户的比特币会被当作 <code>UTXO</code> 分散到数百个交易和数百个区块中</li>
<li>实际上，并不存在储存比特币地址或账户余额的地点，只有被所有者锁住的、分散的 <code>UTXO</code></li>
<li>“一个用户的比特币余额”，这个概念是一个通过比特币钱包应用创建的派生之物。比特币钱包通过扫描区块链并聚合所有属于该用户的 <code>UTXO</code> 来计算该用户的余额</li>
<li><code>UTXO</code> 被每一个全节点比特币客户端在一个储存于内存中的数据库所追踪，该数据库也被称为 <code>UTXO集</code> 或者 <code>UTXO池</code>。新的交易从 <code>UTXO集</code> 中消耗(支付)一个或多个输出</li>
</ul>
<h3 id="交易结构">交易结构</h3>
<h4 id="交易输入（TXInput）">交易输入（TXInput）</h4>
<blockquote>
<h4 id="指明交易发起人可支付资金的来源">指明交易发起人可支付资金的来源</h4>
<p>包含：</p>
<ul>
<li>引用utxo所在交易的ID（知道在哪个房间）</li>
<li>所消费utxo在output中的索引（具体位置）</li>
<li>解锁脚本（签名，公钥）</li>
</ul>
</blockquote>
<h4 id="交易输出（TXOutput）">交易输出（TXOutput）</h4>
<blockquote>
<h4 id="包含资金接收方的相关信息">包含资金接收方的相关信息</h4>
<p>包含：</p>
<ul>
<li>接收金额（数字）</li>
<li>锁定脚本（对方公钥的哈希，这个哈希可以通过地址反推出来，所以转账时知道地址即可)</li>
</ul>
</blockquote>
<h4 id="交易ID">交易ID</h4>
<blockquote>
<p>一般指交易结构的哈希值</p>
</blockquote>
<h2 id="五、V4-版本">五、V4 版本</h2>
<blockquote>
<p><a href="./%E8%B5%84%E6%96%99/v4%E7%89%88%E6%9C%AC%E5%AF%BC%E5%9B%BE%EF%BC%88%E9%AB%98%E8%83%BD%E6%85%8E%E5%85%A5%EF%BC%89.xmind">导图</a></p>
</blockquote>
<h3 id="交易结构的定义">交易结构的定义</h3>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 交易输入（TXInput）</span></span><br><span class="line"><span class="keyword">type</span> TXInput <span class="keyword">struct</span> &#123;</span><br><span class="line">	TXID    []<span class="type">byte</span> <span class="comment">// - 引用utxo所在交易的ID（知道在哪个房间）</span></span><br><span class="line">	Index   <span class="type">int64</span>  <span class="comment">// - 所消费utxo在output中的索引（具体位置）</span></span><br><span class="line">	Address <span class="type">string</span> <span class="comment">// - 解锁脚本（签名，公钥），使用地址模拟</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 交易输出（TXOutput）</span></span><br><span class="line"><span class="keyword">type</span> TXOutput <span class="keyword">struct</span> &#123;</span><br><span class="line">	Value   <span class="type">float64</span> <span class="comment">// - 接收金额（数字）</span></span><br><span class="line">	Address <span class="type">string</span>  <span class="comment">// - 锁定脚本（对方公钥的哈希，这个哈希可以通过地址反推出来，所以转账时知道地址即可)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义交易结构</span></span><br><span class="line"><span class="keyword">type</span> Transaction <span class="keyword">struct</span> &#123;</span><br><span class="line">	TXid      []<span class="type">byte</span>     <span class="comment">// 交易ID</span></span><br><span class="line">	TXInputs  []TXInput  <span class="comment">// 所有的TXInput</span></span><br><span class="line">	TXOutputs []TXOutput <span class="comment">// 所有的TXOutput</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="SetTXID-函数实现">SetTXID 函数实现</h3>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置交易ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Transaction)</span></span> SetTXID() &#123;</span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line"></span><br><span class="line">	encoder := gob.NewEncoder(&amp;buffer)</span><br><span class="line">	err := encoder.Encode(tx)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hash := sha256.Sum256(buffer.Bytes())</span><br><span class="line">	tx.TXid = hash[:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="挖矿交易实现">挖矿交易实现</h3>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现挖矿交易。只有输出，没有有效的输入(不需要引用ID，不需要索引，不需要签名)</span></span><br><span class="line"><span class="comment">// miner 挖矿的人</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCoinBaseTX</span><span class="params">(miner <span class="type">string</span>)</span></span> *Transaction &#123;</span><br><span class="line"></span><br><span class="line">	inputs := []TXInput&#123;</span><br><span class="line">		&#123;<span class="literal">nil</span>, <span class="number">-1</span>, genesisInfo&#125;, <span class="comment">// 设置特殊的值来表示该交易为挖矿交易</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outputs := []TXOutput&#123;</span><br><span class="line">		&#123;<span class="number">12.5</span>, miner&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tx := Transaction&#123;<span class="literal">nil</span>, inputs, outputs&#125;</span><br><span class="line">	tx.SetTXID()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;tx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="使用-Transaction-改写程序">使用 Transaction 改写程序</h3>
<blockquote>
<ul>
<li>改写 Block 结构</li>
<li>根据提示进行相应修改</li>
</ul>
</blockquote>
<h3 id="模拟默克尔根">模拟默克尔根</h3>
<blockquote>
<h5 id="比特币中做哈希，并不是对整个区块做哈希，而是对区块头做哈希">比特币中做哈希，并不是对整个区块做哈希，而是对区块头做哈希</h5>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟默尔克根</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(block *Block)</span></span> HashTransactions() &#123;</span><br><span class="line">	<span class="comment">// 交易ID 就是交易的哈希值，将交易ID拼接起来再整体做一次哈希运算，将得到的值作为默克尔根</span></span><br><span class="line">	<span class="keyword">var</span> hashs []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, tx := <span class="keyword">range</span> block.Transactions &#123;</span><br><span class="line">		txid <span class="comment">/* []byte */</span> := tx.TXid</span><br><span class="line">		hashs = <span class="built_in">append</span>(hashs, txid...)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hash := sha256.Sum256(hashs)</span><br><span class="line"></span><br><span class="line">	block.MerKleRoot = hash[:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="剩余比特币计算">剩余比特币计算</h3>
<blockquote>
<ul>
<li>遍历账本，找到能够支配的 <code>UTXO</code></li>
<li>提出已经花费过的 <code>Output</code></li>
</ul>
</blockquote>
<blockquote>
<h4 id="实现思路">实现思路</h4>
<ul>
<li>遍历账本</li>
<li>遍历交易</li>
<li>遍历 <code>Output</code></li>
<li>找到同一用户的所有 <code>Output</code>
<ul>
<li>此时会找到所有历史上所有属于该用户的 <code>Output</code>，再把花费过的剔除</li>
<li>再添加 <code>Output</code> 之前，遍历 <code>Input</code>，过滤掉已经花费过的 <code>Output</code></li>
</ul>
</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 思路：</span></span><br><span class="line"><span class="comment">// - 遍历账本</span></span><br><span class="line"><span class="comment">// - 遍历交易</span></span><br><span class="line"><span class="comment">// - 遍历 `Output`</span></span><br><span class="line"><span class="comment">// - 找到所有同一用户的 `Output`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> FindMyUtxos(address <span class="type">string</span>) []TXOutput &#123;</span><br><span class="line">	<span class="comment">// TODO</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;FindMyUtxos\n&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> []TXOutput&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> GetBalance(address <span class="type">string</span>) &#123;</span><br><span class="line">	utxos := bc.FindMyUtxos(address)</span><br><span class="line"></span><br><span class="line">	total := <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, utxo := <span class="keyword">range</span> utxos &#123;</span><br><span class="line">		total += utxo.Value <span class="comment">// 剩余总额</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s 的余额为： %f\n&quot;</span>, address, total)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="在-cli-go-中添加-GetBalance-命令，调用-GetBalance-方法">在 <code>cli.go</code> 中添加 <code>GetBalance</code> 命令，调用 <code>GetBalance</code> 方法</h4>
<h5 id=""><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/c72b60d3600eba49a359764f4486b663-%E8%B0%83%E7%94%A8GetBalance%E6%96%B9%E6%B3%95-93472f.png"
                      alt=""
                ></h5>
<h4 id="遍历交易输出-TXOutputs">遍历交易输出 <code>TXOutputs</code></h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> FindMyUtxos(address <span class="type">string</span>) []TXOutput &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;FindMyUtxos\n&quot;</span>)</span><br><span class="line">	<span class="keyword">var</span> UTXOs []TXOutput <span class="comment">// 返回的结构</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 遍历账本</span></span><br><span class="line">	it := bc.NewIterator()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := it.Next()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(block.PrevBlockHash) == <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;遍历区块链结束!\n&quot;</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// - 遍历交易</span></span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> block.Transactions &#123;</span><br><span class="line">			<span class="comment">// - 遍历 `Output`</span></span><br><span class="line">			<span class="keyword">for</span> i, Output := <span class="keyword">range</span> tx.TXOutputs &#123;</span><br><span class="line">				<span class="comment">// - 找到同一用户的所有 `Output`</span></span><br><span class="line">				<span class="keyword">if</span> address == Output.Address &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了属于 [%s] 的output! i: %d\n&quot;</span>, address, i)</span><br><span class="line">					UTXOs = <span class="built_in">append</span>(UTXOs, Output)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> UTXOs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="遍历交易的-Inputs">遍历交易的 Inputs</h4>
<blockquote>
<h4 id="标识使用过的-Output-需要两个数据">标识使用过的 <code>Output</code> 需要两个数据</h4>
<ul>
<li>交易 <code>ID</code></li>
<li><code>Index</code></li>
</ul>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span></span><br></pre></td></tr></table></figure></div>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历交易输入：inputs</span></span><br><span class="line"><span class="keyword">for</span> _, input := <span class="keyword">range</span> tx.TXInputs &#123;</span><br><span class="line">    <span class="keyword">if</span> input.Address == address &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;找到了消耗过的Output！，index: %d\n&quot;</span>, input.Index)</span><br><span class="line">        key := <span class="type">string</span>(input.TXID)</span><br><span class="line">        spentUTXOs[key] = <span class="built_in">append</span>(spentUTXOs[key], input.Index)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="整体遍历过程">整体遍历过程</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> FindMyUtxos(address <span class="type">string</span>) []TXOutput &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;FindMyUtxos\n&quot;</span>)</span><br><span class="line">	<span class="keyword">var</span> UTXOs []TXOutput <span class="comment">// 返回的结构</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 遍历账本</span></span><br><span class="line">	it := bc.NewIterator()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 标识已经消耗过的utxo结构</span></span><br><span class="line">	<span class="comment">// key: 交易id</span></span><br><span class="line">	<span class="comment">// value: 这个id里面的 output的索引数组</span></span><br><span class="line">	spentUTXOs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := it.Next()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(block.PrevBlockHash) == <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;遍历区块链结束!\n&quot;</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// - 遍历交易</span></span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> block.Transactions &#123;</span><br><span class="line">			<span class="comment">// 遍历交易输入：inputs</span></span><br><span class="line">			<span class="keyword">for</span> _, input := <span class="keyword">range</span> tx.TXInputs &#123;</span><br><span class="line">				<span class="keyword">if</span> input.Address == address &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了消耗过的Output！，index: %d\n&quot;</span>, input.Index)</span><br><span class="line">					key := <span class="type">string</span>(input.TXID)</span><br><span class="line">					spentUTXOs[key] = <span class="built_in">append</span>(spentUTXOs[key], input.Index)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		OUTPUT:</span><br><span class="line">			<span class="comment">// - 遍历 `Output`</span></span><br><span class="line">			<span class="keyword">for</span> i, Output := <span class="keyword">range</span> tx.TXOutputs &#123;</span><br><span class="line"></span><br><span class="line">				key := <span class="type">string</span>(tx.TXid)</span><br><span class="line">				indexes := spentUTXOs[key]</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">len</span>(indexes) != <span class="number">0</span> &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了当前这笔交易中，有被消耗过的Output！\n&quot;</span>)</span><br><span class="line">					<span class="keyword">for</span> _, j := <span class="keyword">range</span> indexes &#123;</span><br><span class="line">						<span class="keyword">if</span> <span class="type">int64</span>(i) == j &#123;</span><br><span class="line">							fmt.Printf(<span class="string">&quot;i == j, 当前的Output已经被消耗饿了，跳过不统计!&quot;</span>)</span><br><span class="line">							<span class="keyword">continue</span> OUTPUT</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// - 找到同一用户的所有 `Output`</span></span><br><span class="line">				<span class="keyword">if</span> address == Output.Address &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了属于 [%s] 的output! i: %d\n&quot;</span>, address, i)</span><br><span class="line">					UTXOs = <span class="built_in">append</span>(UTXOs, Output)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> UTXOs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="创建普通交易">创建普通交易</h3>
<blockquote>
<h4 id="分析">分析</h4>
<ul>
<li>参数：
<ul>
<li>付款人</li>
<li>收款人</li>
<li>转账金额</li>
<li><code>bc</code> 实例</li>
</ul>
</li>
<li>逻辑：
<ul>
<li>遍历账本，找到属于付款人的合适的金额的 <code>outputs</code></li>
<li>如果金额不足以转账，则创建交易失败</li>
<li>将 <code>outputs</code> 转成 <code>inputs</code></li>
<li>创建输出，创建一个属于收款人的 <code>output</code></li>
<li>如果有找零则创建一个属于付款人的 <code>output</code></li>
<li>创建交易</li>
<li>设置交易 <code>ID</code></li>
<li>返回交易结构</li>
</ul>
</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTransaction</span><span class="params">(from, to <span class="type">string</span>, amount <span class="type">float64</span>, bc *BlockChain)</span></span> *Transaction &#123;</span><br><span class="line"></span><br><span class="line">	utxos := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>) <span class="comment">// 标识能用的utxo</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> resValue <span class="type">float64</span> <span class="comment">// 这些utxo存储的金额</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 遍历账本，找到属于付款人的合适的金额的 `outputs`</span></span><br><span class="line">	utxos, resValue = bc.FindNeedUtxo(from, amount)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 如果金额不足以转账，则创建交易失败</span></span><br><span class="line">	<span class="keyword">if</span> resValue &lt; amount &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;余额不足，交易失败!\n&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 将 `outputs` 转成 `inputs`</span></span><br><span class="line">	<span class="keyword">var</span> inputs []TXInput</span><br><span class="line">	<span class="keyword">var</span> outputs []TXOutput</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> txid, indexes := <span class="keyword">range</span> utxos &#123;</span><br><span class="line">		<span class="keyword">for</span> _, i := <span class="keyword">range</span> indexes &#123;</span><br><span class="line">			input := TXInput&#123;[]<span class="type">byte</span>(txid), i, from&#125;</span><br><span class="line">			inputs = <span class="built_in">append</span>(inputs, input)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 创建输出，创建一个属于收款人的 `output`</span></span><br><span class="line">	output := TXOutput&#123;amount, to&#125;</span><br><span class="line">	outputs = <span class="built_in">append</span>(outputs, output)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 如果有找零则创建一个属于付款人的 `output`</span></span><br><span class="line">	<span class="keyword">if</span> resValue &gt; amount &#123;</span><br><span class="line">		output = TXOutput&#123;resValue - amount, from&#125;</span><br><span class="line">		outputs = <span class="built_in">append</span>(outputs, output)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 创建交易</span></span><br><span class="line">	tx := Transaction&#123;<span class="literal">nil</span>, inputs, outputs&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 设置交易 `ID`</span></span><br><span class="line">	tx.SetTXID()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 返回交易结构</span></span><br><span class="line">	<span class="keyword">return</span> &amp;tx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="FindNeedUtxo">FindNeedUtxo</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// - 遍历账本，找到属于付款人的合适的金额的 `outputs`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> FindNeedUtxo(from <span class="type">string</span>, amount <span class="type">float64</span>) (<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>, <span class="type">float64</span>) &#123;</span><br><span class="line"></span><br><span class="line">	needUtxos := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>) <span class="comment">// 标识能用的utxo</span></span><br><span class="line">	<span class="keyword">var</span> resValue <span class="type">float64</span>                  <span class="comment">// 统计金额</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 遍历账本</span></span><br><span class="line">	it := bc.NewIterator()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 标识已经消耗过的utxo结构</span></span><br><span class="line">	<span class="comment">// key: 交易id</span></span><br><span class="line">	<span class="comment">// value: 这个id里面的 output的索引数</span></span><br><span class="line">	spentUTXOs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := it.Next()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(block.PrevBlockHash) == <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;遍历区块链结束!\n&quot;</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// - 遍历交易</span></span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> block.Transactions &#123;</span><br><span class="line">			<span class="comment">// 遍历交易输入：inputs</span></span><br><span class="line">			<span class="keyword">for</span> _, input := <span class="keyword">range</span> tx.TXInputs &#123;</span><br><span class="line">				<span class="keyword">if</span> input.Address == from &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了消耗过的Output！，index: %d\n&quot;</span>, input.Index)</span><br><span class="line">					key := <span class="type">string</span>(input.TXID)</span><br><span class="line">					spentUTXOs[key] = <span class="built_in">append</span>(spentUTXOs[key], input.Index)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		OUTPUT:</span><br><span class="line">			<span class="comment">// - 遍历 `Output`</span></span><br><span class="line">			<span class="keyword">for</span> i, Output := <span class="keyword">range</span> tx.TXOutputs &#123;</span><br><span class="line"></span><br><span class="line">				key := <span class="type">string</span>(tx.TXID)</span><br><span class="line"></span><br><span class="line">				indexes := spentUTXOs[key]</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">len</span>(indexes) != <span class="number">0</span> &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了当前这笔交易中，有被消耗过的Output！\n&quot;</span>)</span><br><span class="line">					<span class="keyword">for</span> _, j := <span class="keyword">range</span> indexes &#123;</span><br><span class="line">						<span class="keyword">if</span> <span class="type">int64</span>(i) == j &#123;</span><br><span class="line">							fmt.Printf(<span class="string">&quot;i == j, 当前的Output已经被消耗过了，跳过不统计!&quot;</span>)</span><br><span class="line">							<span class="keyword">continue</span> OUTPUT</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// - 找到同一用户的所有 `Output`</span></span><br><span class="line">				<span class="keyword">if</span> from == Output.Address &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了属于 [%s] 的output! i: %d\n&quot;</span>, from, i)</span><br><span class="line">					<span class="comment">// UTXOs = append(UTXOs, Output)</span></span><br><span class="line"></span><br><span class="line">					<span class="comment">// 找到符合条件的output</span></span><br><span class="line">					<span class="comment">// 添加到返回结构中needUtxos</span></span><br><span class="line">					needUtxos[key] = <span class="built_in">append</span>(needUtxos[key], <span class="type">int64</span>(i))</span><br><span class="line">					resValue += Output.Value</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 判断金额是否足够</span></span><br><span class="line">					<span class="keyword">if</span> resValue &gt;= amount &#123;</span><br><span class="line">						<span class="comment">// - 足够，直接返回</span></span><br><span class="line">						<span class="keyword">return</span> needUtxos, resValue</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">// - 不够，继续遍历</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> needUtxos, <span class="number">0.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="send-命令实现">send 命令实现</h3>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> Send(from, to <span class="type">string</span>, amount <span class="type">float64</span>, miner, data <span class="type">string</span>) &#123;</span><br><span class="line">	<span class="comment">// 创建挖矿交易</span></span><br><span class="line">	coinbase := NewCoinBaseTX(miner, data)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建普通交易</span></span><br><span class="line">	tx := NewTransaction(from, to, amount, cli.bc)</span><br><span class="line"></span><br><span class="line">	txs := []*Transaction&#123;coinbase&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> tx != <span class="literal">nil</span> &#123;</span><br><span class="line">		txs = <span class="built_in">append</span>(txs, tx)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">// 金额不足</span></span><br><span class="line">		fmt.Printf(<span class="string">&quot;发现无效交易，过滤！\n&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加到区块</span></span><br><span class="line">	cli.bc.AddBlock(txs)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;挖矿成功！\n&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="添加-send-命令">添加 send 命令</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;send&quot;</span>:</span><br><span class="line">    fmt.Printf(<span class="string">&quot;转账命令被调用！\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(cmds) != <span class="number">7</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;send命令无效参数\n&quot;</span>)</span><br><span class="line">        fmt.Println(Usage)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ./blockchain send FROM TO AMOUNT　MINER 转账命令</span></span><br><span class="line">    from := cmds[<span class="number">2</span>]</span><br><span class="line">    to := cmds[<span class="number">3</span>]</span><br><span class="line">    amount, _ := strconv.ParseFloat(cmds[<span class="number">4</span>], <span class="number">64</span>)</span><br><span class="line">    miner := cmds[<span class="number">5</span>]</span><br><span class="line">    data := cmds[<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">    cli.Send(from, to, amount, miner, data)</span><br></pre></td></tr></table></figure></div>
<h3 id="FindMyUtxos-与-FindNeedUtxo-整合">FindMyUtxos 与 FindNeedUtxo 整合</h3>
<blockquote>
<ul>
<li><code>FindMyUtxos</code>：找到所有的 <code>utxo</code> 只要 <code>output</code> 就可以</li>
<li><code>FindNeedUtxo</code>：找到需要的 <code>utxo</code> 只要 <code>output</code> 的定位</li>
</ul>
</blockquote>
<h4 id="UTXOInfo">UTXOInfo</h4>
<blockquote>
<h4 id="定义-UTXOInfo-结构。同时包含-output-已经定位的信息">定义 <code>UTXOInfo</code> 结构。同时包含 <code>output</code> 已经定位的信息</h4>
<ul>
<li>TXID</li>
<li>index</li>
<li>output</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 `UTXOInfo`结构钢。同时包含 `output` 已经定位的信息</span></span><br><span class="line"><span class="keyword">type</span> UTXOInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">	TXID   []<span class="type">byte</span>   <span class="comment">// 交易ID</span></span><br><span class="line">	Index  <span class="type">int64</span>    <span class="comment">// output的索引值</span></span><br><span class="line">	Output TXOutput <span class="comment">// Output本身</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="改写-FindMyUtxos">改写 FindMyUtxos</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> FindMyUtxos(address <span class="type">string</span>) []UTXOInfo &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;FindMyUtxos\n&quot;</span>)</span><br><span class="line">	<span class="comment">// var UTXOs []TXOutput // 返回的结构</span></span><br><span class="line">	<span class="keyword">var</span> UTXOInfos []UTXOInfo <span class="comment">// 新的返回结构</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 遍历账本</span></span><br><span class="line">	it := bc.NewIterator()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 标识已经消耗过的utxo结构</span></span><br><span class="line">	<span class="comment">// key: 交易id</span></span><br><span class="line">	<span class="comment">// value: 这个id里面的 output的索引数</span></span><br><span class="line">	spentUTXOs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := it.Next()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(block.PrevBlockHash) == <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;遍历区块链结束!\n&quot;</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// - 遍历交易</span></span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> block.Transactions &#123;</span><br><span class="line">			<span class="comment">// 遍历交易输入：inputs</span></span><br><span class="line">			<span class="keyword">for</span> _, input := <span class="keyword">range</span> tx.TXInputs &#123;</span><br><span class="line">				<span class="keyword">if</span> input.Address == address &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了消耗过的Output！，index: %d\n&quot;</span>, input.Index)</span><br><span class="line">					key := <span class="type">string</span>(input.TXID)</span><br><span class="line">					spentUTXOs[key] = <span class="built_in">append</span>(spentUTXOs[key], input.Index)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		OUTPUT:</span><br><span class="line">			<span class="comment">// - 遍历 `Output`</span></span><br><span class="line">			<span class="keyword">for</span> i, Output := <span class="keyword">range</span> tx.TXOutputs &#123;</span><br><span class="line"></span><br><span class="line">				key := <span class="type">string</span>(tx.TXID)</span><br><span class="line"></span><br><span class="line">				indexes := spentUTXOs[key]</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">len</span>(indexes) != <span class="number">0</span> &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了当前这笔交易中，有被消耗过的Output！\n&quot;</span>)</span><br><span class="line">					<span class="keyword">for</span> _, j := <span class="keyword">range</span> indexes &#123;</span><br><span class="line">						<span class="keyword">if</span> <span class="type">int64</span>(i) == j &#123;</span><br><span class="line">							fmt.Printf(<span class="string">&quot;i == j, 当前的Output已经被消耗过了，跳过不统计!&quot;</span>)</span><br><span class="line">							<span class="keyword">continue</span> OUTPUT</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// - 找到同一用户的所有 `Output`</span></span><br><span class="line">				<span class="keyword">if</span> address == Output.Address &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;找到了属于 [%s] 的output! i: %d\n&quot;</span>, address, i)</span><br><span class="line">					<span class="comment">// UTXOs = append(UTXOs, Output)</span></span><br><span class="line">					utxoinfo := UTXOInfo&#123;tx.TXID, <span class="type">int64</span>(i), Output&#125;</span><br><span class="line">					UTXOInfos = <span class="built_in">append</span>(UTXOInfos, utxoinfo)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> UTXOInfos</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="改写-Getbalance">改写 Getbalance</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> GetBalance(address <span class="type">string</span>) &#123;</span><br><span class="line">	utxoInfos := bc.FindMyUtxos(address)</span><br><span class="line"></span><br><span class="line">	total := <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 所有的output都在utxoInfos内部，获取余额只需遍历utxoInfos获取output即可</span></span><br><span class="line">	<span class="keyword">for</span> _, utxoInfo := <span class="keyword">range</span> utxoInfos &#123;</span><br><span class="line">		total += utxoInfo.Output.Value <span class="comment">// 剩余总额</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s 的余额为： %f\n&quot;</span>, address, total)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="改写-FindNeedUtxo">改写 FindNeedUtxo</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// - 遍历账本，找到属于付款人的合适的金额的 `outputs`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> FindNeedUtxo(from <span class="type">string</span>, amount <span class="type">float64</span>) (<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>, <span class="type">float64</span>) &#123;</span><br><span class="line"></span><br><span class="line">	needUtxos := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>) <span class="comment">// 标识能用的utxo</span></span><br><span class="line">	<span class="keyword">var</span> resValue <span class="type">float64</span>                  <span class="comment">// 统计金额</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 复用FindMyUtxo函数，这个函数已经包含了所有的信息</span></span><br><span class="line">	utxoInfos := bc.FindMyUtxos(from)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, utxoInfo := <span class="keyword">range</span> utxoInfos &#123;</span><br><span class="line">		key := <span class="type">string</span>(utxoInfo.TXID)</span><br><span class="line"></span><br><span class="line">		needUtxos[key] = <span class="built_in">append</span>(needUtxos[key], <span class="type">int64</span>(utxoInfo.Index))</span><br><span class="line">		resValue += utxoInfo.Output.Value</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 判断金额是否足够</span></span><br><span class="line">		<span class="keyword">if</span> resValue &gt;= amount &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> needUtxos, resValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="其余操作">其余操作</h3>
<blockquote>
<p>使用 <code>IsCoinbase</code> 函数判断某个交易是否是挖矿交易</p>
<p>单独实现创建区块链的命令</p>
</blockquote>
<h4 id="IsCoinbase"><code>IsCoinbase</code></h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// transaction.go</span></span><br><span class="line"><span class="comment">// 判断某个交易是否是挖矿交易</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Transaction)</span></span> IsCoinbase() <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="comment">// 挖矿交易：只有一个Input；引用的id是nil；引用的索引是 -1</span></span><br><span class="line">	inputs := tx.TXInputs</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(inputs) == <span class="number">1</span> &amp;&amp; inputs[<span class="number">0</span>].TXID == <span class="literal">nil</span> &amp;&amp; inputs[<span class="number">0</span>].Index == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在遍历-Inputs-时使用">在遍历 <code>Inputs</code> 时使用</h5>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/1f6eab1461921fb47cf2013711118cbb-IsCoinbase-e11ca6.png"
                      alt=""
                ></p>
<h4 id="添加创建区块链命令">添加创建区块链命令</h4>
<blockquote>
<ul>
<li>
<p>添加 <code>CreateBlockChain</code> 命令，只创建区块链（只能被调用一次）</p>
</li>
<li>
<p>把返回区块链的实例用一个新的函数实现（不单独使用，而是在操作区块链之前调用）</p>
</li>
</ul>
</blockquote>
<h5 id="创建区块链函数">创建区块链函数</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建区块链方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateBlockChain</span><span class="params">(miner <span class="type">string</span>)</span></span> *BlockChain &#123;</span><br><span class="line">	<span class="comment">// 1.获取数据库句柄，打开数据库，读写数据</span></span><br><span class="line">	db, err := bolt.Open(blockChainName, <span class="number">0600</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// defer db.Close() 不在此处关闭</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> tail []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	db.Update(<span class="function"><span class="keyword">func</span><span class="params">(t *bolt.Tx)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		bucket, err := t.CreateBucket([]<span class="type">byte</span>(blockBucketName))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Panic(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 添加创世块，创世块中只有一个交易，只有Coinbase</span></span><br><span class="line">		coinbase := NewCoinBaseTX(miner, genesisInfo)</span><br><span class="line"></span><br><span class="line">		genesisBlock := NewBlock(</span><br><span class="line">			[]*Transaction&#123;</span><br><span class="line">				coinbase,</span><br><span class="line">			&#125;,</span><br><span class="line">			[]<span class="type">byte</span>&#123;&#125;,</span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">		bucket.Put(genesisBlock.Hash, genesisBlock.serialize() <span class="comment">/* 将区块序列化，转为字节流 */</span>)</span><br><span class="line">		bucket.Put([]<span class="type">byte</span>(lastHashKey), genesisBlock.Hash)</span><br><span class="line"></span><br><span class="line">		tail = genesisBlock.Hash</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;BlockChain&#123;db, tail&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="获取区块链实例函数">获取区块链实例函数</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回区块链实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockChain</span><span class="params">()</span></span> *BlockChain &#123;</span><br><span class="line">	<span class="comment">// 1.获取数据库句柄，打开数据库，读写数据</span></span><br><span class="line">	db, err := bolt.Open(blockChainName, <span class="number">0600</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// defer db.Close() 不在此处关闭</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> tail []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	db.View(<span class="function"><span class="keyword">func</span><span class="params">(t *bolt.Tx)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="comment">// 准备bucket</span></span><br><span class="line">		bucket := t.Bucket([]<span class="type">byte</span>(blockBucketName))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> bucket == <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Panic(<span class="string">&quot;区块链bucket为空!\n&quot;</span>)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tail = bucket.Get([]<span class="type">byte</span>(lastHashKey))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;BlockChain&#123;db, tail&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="添加-CreateBlockChain-命令">添加 CreateBlockChain 命令</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> CreateBlockChain(address <span class="type">string</span>) &#123;</span><br><span class="line">	bc := CreateBlockChain(address)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> bc.db.Close()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;创建区块链成功！\n&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<h4 id="在-cli-go-中添加命令">在 <code>cli.go</code> 中添加命令</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;createblockchain&quot;</span>:</span><br><span class="line">		<span class="comment">// 校验参数个数是否满足要求</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(cmds) != <span class="number">3</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;无效的命令\n&quot;</span>)</span><br><span class="line">			fmt.Println(Usage)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;创建区块链命令被调用，数据： %s\n&quot;</span>, cmds[<span class="number">2</span>])</span><br><span class="line">		address := cmds[<span class="number">2</span>]</span><br><span class="line">		cli.CreateBlockChain(address)</span><br></pre></td></tr></table></figure></div>
</blockquote>
<h5 id="主函数">主函数</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli := CLI&#123;&#125;</span><br><span class="line">	cli.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在-commands-go-中调用-NewBlockChain-函数">在 <code>commands.go</code> 中调用 <code>NewBlockChain</code> 函数</h5>
<blockquote>
<p>以获取余额为例</p>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取余额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> GetBalance(address <span class="type">string</span>) &#123;</span><br><span class="line">	bc := NewBlockChain()</span><br><span class="line">	<span class="keyword">defer</span> bc.db.Close()</span><br><span class="line"></span><br><span class="line">	bc.GetBalance(address)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="判断区块链文件是否存在">判断区块链文件是否存在</h4>
<blockquote>
<h4 id="判断-blockChain-db-是否存在">判断 <code>blockChain.db</code> 是否存在</h4>
<ul>
<li>存在，不允许再次创建</li>
<li>没有，则在所有操作之前，必须先创建区块链</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils.go</span></span><br><span class="line"><span class="comment">// 判断文件是否存在</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsFileExist</span><span class="params">(fileName <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	_, err := os.Stat(fileName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在-NewBlockChain-中调用">在 <code>NewBlockChain</code> 中调用</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockChain</span><span class="params">()</span></span> *BlockChain &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !IsFileExist(blockChainName) &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;区块链不存在，请先创建!\n&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	... ...	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在-CreateBlockChain-中调用">在 <code>CreateBlockChain</code> 中调用</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateBlockChain</span><span class="params">(miner <span class="type">string</span>)</span></span> *BlockChain &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> IsFileExist(blockChainName) &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;区块链已经存在，不需要重复创建！\n&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在-commands-go-中进行有效性判断">在 <code>commands.go</code> 中进行有效性判断</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> Send(from, to <span class="type">string</span>, amount <span class="type">float64</span>, miner, data <span class="type">string</span>) &#123;</span><br><span class="line">	bc := NewBlockChain()</span><br><span class="line">	<span class="keyword">if</span> bc == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> bc.db.Close()</span><br><span class="line">    </span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="六、V5-版本">六、V5 版本</h2>
<blockquote>
<h4 id="V4-版本存在的问题"><code>V4</code> 版本存在的问题</h4>
<ul>
<li>地址是用字符串代替的</li>
<li>没有校验</li>
</ul>
</blockquote>
<blockquote>
<h4 id="解决步骤">解决步骤</h4>
<ol>
<li>创建密钥对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span> 公钥 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span>​ 地址
<ul>
<li>使用椭圆曲线算法生成私钥</li>
<li>由私钥生成公钥</li>
<li>由公钥生成地址</li>
<li>钱包 <code>wallet.dat</code> （保存所有的公钥、私钥、地址）</li>
</ul>
</li>
<li>使用地址、公钥改写代码</li>
<li>交易签名校验
<ul>
<li>私钥签名
<ul>
<li>创建交易时使用私钥对交易进行签名</li>
</ul>
</li>
<li>校验
<ul>
<li>打包交易之前对交易进行校验</li>
</ul>
</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="ecdsa-签名-demo">ecdsa 签名 demo</h3>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/ecdsa&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/elliptic&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 1.创建私钥</span></span><br><span class="line">	curve := elliptic.P256()</span><br><span class="line">	privateKey, err := ecdsa.GenerateKey(curve, rand.Reader)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2.创建公钥</span></span><br><span class="line">	pubKey := privateKey.PublicKey</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3.私钥对数据进行签名(对数据的哈希值进行签名)</span></span><br><span class="line">	data := <span class="string">&quot;hello world!&quot;</span></span><br><span class="line">	dataHash := sha256.Sum256([]<span class="type">byte</span>(data))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// func ecdsa.Sign(rand io.Reader, priv *ecdsa.PrivateKey, hash []byte) (r *big.Int, s *big.Int, err error)</span></span><br><span class="line">	r, s, err := ecdsa.Sign(rand.Reader, privateKey, dataHash[:])</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 传输过程中一般不会直接传输r、s，而是将r、s拼成字节流再进行传输</span></span><br><span class="line">	<span class="comment">// fmt.Printf(&quot;r: %x\n len(r): %d\n r.Bytes(): %x\n len(r.Bytes()): %d\n&quot;, r, r.BitLen(), r.Bytes(), len(r.Bytes()))</span></span><br><span class="line">	<span class="comment">// fmt.Printf(&quot;s: %x\n len(s): %d\n s.Bytes(): %x\n len(s.Bytes()): %d\n&quot;, s, s.BitLen(), s.Bytes(), len(s.Bytes()))</span></span><br><span class="line">	signagure := <span class="built_in">append</span>(r.Bytes(), s.Bytes()...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 传输中。。。。。。</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.在接收端使用数据、签名、公钥进行校验</span></span><br><span class="line">	<span class="comment">// 在接收端将r、s切割出来</span></span><br><span class="line">	<span class="keyword">var</span> r1 big.Int</span><br><span class="line">	<span class="keyword">var</span> s1 big.Int</span><br><span class="line"></span><br><span class="line">	r1Data := signagure[:<span class="built_in">len</span>(signagure)/<span class="number">2</span>]</span><br><span class="line">	s1Data := signagure[<span class="built_in">len</span>(signagure)/<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">	r1.SetBytes(r1Data)</span><br><span class="line">	s1.SetBytes(s1Data)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;r:\t %x len(r): %d\n&quot;</span>, r.Bytes(), <span class="built_in">len</span>(r.Bytes()))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;s:\t %x len(s): %d\n&quot;</span>, s.Bytes(), <span class="built_in">len</span>(s.Bytes()))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;r1:\t %x len(r1): %d\n&quot;</span>, r1.Bytes(), <span class="built_in">len</span>(r1.Bytes()))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;s1:\t %x len(s1): %d\n&quot;</span>, s1.Bytes(), <span class="built_in">len</span>(s1.Bytes()))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// func ecdsa.Verify(pub *ecdsa.PublicKey, hash []byte, r *big.Int, s *big.Int) bool</span></span><br><span class="line">	res := ecdsa.Verify(&amp;pubKey, dataHash[:], &amp;r1, &amp;s1)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;res: %v\n&quot;</span>, res)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="生成新的比特币地址">生成新的比特币地址</h3>
<blockquote>
<h4 id="步骤">步骤</h4>
<ol>
<li>
<p>创建一个结构 <code>WalletKeyPair</code> 密钥对，用于保存公钥和私钥</p>
</li>
<li>
<p>给该结构提供一个 <code>GetAddress</code> 方法通过公钥获取地址</p>
</li>
<li>
<p>地址生成规则</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/0cfce796ecfc6fd14b23150fe2671171-%E6%AF%94%E7%89%B9%E5%B8%81%E5%9C%B0%E5%9D%80%E7%94%9F%E6%88%90%E6%B5%81%E7%A8%8B-1f13dd.png"
                      alt=""
                ></p>
</li>
</ol>
</blockquote>
<h4 id="创建一个结构-WalletKeyPair-密钥对">创建一个结构 <code>WalletKeyPair</code> 密钥对</h4>
<blockquote>
<h5 id="用于保存公钥和私钥">用于保存公钥和私钥</h5>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建一个结构 `WalletKeyPair` 密钥对，用于保存公钥和私钥</span></span><br><span class="line"><span class="keyword">type</span> WalletKeyPair <span class="keyword">struct</span> &#123;</span><br><span class="line">	PrivateKey *ecdsa.PrivateKey</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PublicKey represents an ECDSA public key.</span></span><br><span class="line">	<span class="comment">// type PublicKey struct &#123;</span></span><br><span class="line">	<span class="comment">// 		elliptic.Curve</span></span><br><span class="line">	<span class="comment">// 		X, Y *big.Int</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将公钥的X、Y进行字节流拼接后传输，这样在接收端再进行切割还原，方便编码和传输</span></span><br><span class="line">	PublicKey []<span class="type">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="NewWalletKeyPair-方法实现"><code>NewWalletKeyPair</code> 方法实现</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWalletKeyPair</span><span class="params">()</span></span> *WalletKeyPair &#123;</span><br><span class="line"></span><br><span class="line">	privateKey, err := ecdsa.GenerateKey(elliptic.P256(), rand.Reader)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	publicKeyRaw := privateKey.PublicKey</span><br><span class="line"></span><br><span class="line">	pucblicKey := <span class="built_in">append</span>(publicKeyRaw.X.Bytes(), privateKey.Y.Bytes()...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;WalletKeyPair&#123;privateKey, pucblicKey&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="GetAddress-方法实现"><code>GetAddress</code> 方法实现</h5>
<blockquote>
<h5 id="给-WalletKeyPait-结构提供一个-GetAddress-方法通过公钥获取地址">给 <code>WalletKeyPait</code> 结构提供一个 <code>GetAddress</code> 方法通过公钥获取地址</h5>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 给该结构提供一个 `GetAddress` 方法通过公钥获取地址</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *WalletKeyPair)</span></span> GetAddress() <span class="type">string</span> &#123;</span><br><span class="line">	hash := sha256.Sum256(w.PublicKey)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个hash160对象</span></span><br><span class="line">	<span class="comment">// 向hash160中write数据</span></span><br><span class="line">	rip160Hasher := ripemd160.New()</span><br><span class="line"></span><br><span class="line">	_, err := rip160Hasher.Write(hash[:])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sum appends the current hash to b and returns the resulting slice.</span></span><br><span class="line">	<span class="comment">// It does not change the underlying hash state.</span></span><br><span class="line">	<span class="comment">// Sum(b []byte) []byte</span></span><br><span class="line">	publicHash := rip160Hasher.Sum(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	version := <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 21字节的数据</span></span><br><span class="line">	payload := <span class="built_in">append</span>([]<span class="type">byte</span>&#123;<span class="type">byte</span>(version)&#125;, publicHash...)</span><br><span class="line"></span><br><span class="line">	first := sha256.Sum256(payload)</span><br><span class="line">	second := sha256.Sum256(first[:])</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4字节校验码</span></span><br><span class="line">	checksum := second[<span class="number">0</span>:<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 25字节数据</span></span><br><span class="line">	payload = <span class="built_in">append</span>(payload, checksum...)</span><br><span class="line"></span><br><span class="line">	address := base58.Encode(payload)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> address</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="定义钱包结构">定义钱包结构</h4>
<blockquote>
<h5 id="这是对外的">这是对外的</h5>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wallets结构</span></span><br><span class="line"><span class="comment">// 把地址和秘钥对 对应起来</span></span><br><span class="line"><span class="comment">// map[address1] -&gt; walletKeyPair1</span></span><br><span class="line"><span class="comment">// map[address2] -&gt; walletKeyPair2</span></span><br><span class="line"><span class="comment">// map[address3] -&gt; walletKeyPair3</span></span><br><span class="line"><span class="keyword">type</span> Wallets <span class="keyword">struct</span> &#123;</span><br><span class="line">	WalletsMap <span class="keyword">map</span>[<span class="type">string</span>]*WalletKeyPair</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="创建新的钱包">创建新的钱包</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Wallets，返回Wallets的实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWallets</span><span class="params">()</span></span> *Wallets &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> ws Wallets</span><br><span class="line"></span><br><span class="line">	ws.WalletsMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*WalletKeyPair)</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 1.把所有的钱包从本地加载出来</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2.返回实例</span></span><br><span class="line">	<span class="keyword">return</span> &amp;ws</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="获取钱包实例">获取钱包实例</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Wallets是对外的，WalletKeyPair是对内的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *Wallets)</span></span> CreateWallte() <span class="type">string</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用NewWalletKeyPair</span></span><br><span class="line">	wallet := NewWalletKeyPair()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将返回的walletKeyPair添加到WalletMap中</span></span><br><span class="line">	address := wallet.GetAddress()</span><br><span class="line"></span><br><span class="line">	ws.WalletsMap[address] = wallet</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 保存到本地</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> address</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="调用">调用</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> CreateWallet() &#123;</span><br><span class="line">	ws := NewWallets()</span><br><span class="line">	address := ws.CreateWallte()</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;address: %s\n&quot;</span>, address)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="保存钱包到本地文件">保存钱包到本地文件</h4>
<blockquote>
<h5 id="注意">注意</h5>
<ol>
<li>
<p><code>gob.Register</code>：对于结构中的 <code>interface</code> 类型，需要明确类型</p>
 <div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册接口类型</span></span><br><span class="line">gob.Register(elliptic.P256())</span><br></pre></td></tr></table></figure></div>
</li>
<li>
<p><code>ioutil.WriteFile</code>：实现文件写入</p>
</li>
</ol>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存钱包到本地文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *Wallets)</span></span> SaveToFile() <span class="type">bool</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将接口类型注册一下</span></span><br><span class="line">	gob.Register(elliptic.P256())</span><br><span class="line"></span><br><span class="line">	encoder := gob.NewEncoder(&amp;buffer)</span><br><span class="line"></span><br><span class="line">	err := encoder.Encode(ws.WalletsMap)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;钱包序列化失败! err: %s\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	content := buffer.Bytes()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// func ioutil.WriteFile(filename string, data []byte, perm fs.FileMode) error</span></span><br><span class="line">	err = ioutil.WriteFile(WalletName, content, <span class="number">0600</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;钱包创建失败！err: %s\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="从本地文件中加载钱包">从本地文件中加载钱包</h4>
<blockquote>
<h5 id="注意-2">注意</h5>
<ol>
<li>
<p><code>gob.Register</code>：对于结构中的 <code>interface</code> 类型，需要明确类型</p>
 <div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gob解码</span></span><br><span class="line">gob.Register(elliptic.P256())</span><br></pre></td></tr></table></figure></div>
</li>
<li>
<p><code>ioutil.ReadFile</code>：实现文件的读取操作</p>
</li>
</ol>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从本地文件加载钱包</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *Wallets)</span></span> LoadFromFile() <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="comment">// 判断文件是否不存在</span></span><br><span class="line">	<span class="keyword">if</span> !IsFileExist(WalletName) &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;钱包文件不存在，准备创建！&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 读取文件</span></span><br><span class="line">	content, err := ioutil.ReadFile(WalletName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;读取本地文件失败，err: %s\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// gob解码</span></span><br><span class="line">	gob.Register(elliptic.P256())</span><br><span class="line">	decoder := gob.NewDecoder(bytes.NewReader(content))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> wallets Wallets</span><br><span class="line"></span><br><span class="line">	err = decoder.Decode(&amp;wallets)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;读取本地文件失败，err: %s\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 赋值给ws</span></span><br><span class="line">	ws.WalletsMap = wallets.WalletsMap</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="打印所有钱包的地址">打印所有钱包的地址</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wallets.go</span></span><br><span class="line"><span class="comment">// 获取所有的钱包地址</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *Wallets)</span></span> ListAddress() []<span class="type">string</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 遍历ws.WalletsMap中的key即可</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> addresses []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> address, _ := <span class="keyword">range</span> ws.WalletsMap &#123;</span><br><span class="line">		addresses = <span class="built_in">append</span>(addresses, address)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> addresses</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commands.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *CLI)</span></span> ListAddresses() &#123;</span><br><span class="line">	ws := NewWallets()</span><br><span class="line"></span><br><span class="line">	addresses := ws.ListAddress()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, address := <span class="keyword">range</span> addresses &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;address: %s\n&quot;</span>, address)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli.go</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;listaddresses&quot;</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;打印所有钱包地址命令被调用!&quot;</span>)</span><br><span class="line">    cli.ListAddresses()</span><br></pre></td></tr></table></figure></div>
<h3 id="改写程序">改写程序</h3>
<h4 id="改写-TXInput-和-TXOutput">改写 TXInput 和 TXOutput</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 交易输入（TXInput）</span></span><br><span class="line"><span class="keyword">type</span> TXInput <span class="keyword">struct</span> &#123;</span><br><span class="line">	TXID  []<span class="type">byte</span> <span class="comment">// - 引用utxo所在交易的ID（知道在哪个房间）</span></span><br><span class="line">	Index <span class="type">int64</span>  <span class="comment">// - 所消费utxo在output中的索引（具体位置）</span></span><br><span class="line">	<span class="comment">// Address string // - 解锁脚本（签名，公钥），使用地址模拟</span></span><br><span class="line">	Signalture []<span class="type">byte</span> <span class="comment">// 交易哈希</span></span><br><span class="line">	PublicKey  []<span class="type">byte</span> <span class="comment">// 公钥，不是公钥哈希</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 交易输出（TXOutput）</span></span><br><span class="line"><span class="keyword">type</span> TXOutput <span class="keyword">struct</span> &#123;</span><br><span class="line">	Value <span class="type">float64</span> <span class="comment">// - 接收金额（数字）</span></span><br><span class="line">	<span class="comment">// Address string  // - 锁定脚本（对方公钥的哈希，这个哈希可以通过地址反推出来，所以转账时知道地址即可)</span></span><br><span class="line">	PublicKeyHash []<span class="type">byte</span> <span class="comment">// 公钥哈希，不是公钥本身</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="TXOutput-提供-Lock-方法">TXOutput 提供 Lock 方法</h4>
<blockquote>
<h4 id="给定转账地址，得到该地址的公钥哈希，完成对output的锁定">给定转账地址，得到该地址的公钥哈希，完成对output的锁定</h4>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给定转账地址，得到该地址的公钥哈希，完成对output的锁定</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(output *TXOutput)</span></span> Lock(address <span class="type">string</span>) &#123;</span><br><span class="line">	<span class="comment">// address -&gt; public key hash</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 25字节</span></span><br><span class="line">	decodeInfo := base58.Decode(address)</span><br><span class="line"></span><br><span class="line">	puclicKeyHash := decodeInfo[<span class="number">1</span> : <span class="built_in">len</span>(decodeInfo)<span class="number">-4</span>]</span><br><span class="line"></span><br><span class="line">	output.PublicKeyHash = puclicKeyHash</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="创建-TXOutput">创建 TXOutput</h4>
<blockquote>
<p>因为创建过程需要调用 <code>Lock</code> 方法，因此定义一个 <code>NewTXOuput</code> 方法</p>
</blockquote>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTXOutput</span><span class="params">(value <span class="type">float64</span>, address <span class="type">string</span>)</span></span> TXOutput &#123;</span><br><span class="line">	output := TXOutput&#123;Value: value&#125;</span><br><span class="line"></span><br><span class="line">	output.Lock(address)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> output</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="改写-NewCoinbaseTX">改写 NewCoinbaseTX</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义奖励值为常量</span></span><br><span class="line"><span class="comment">// 挖矿奖励</span></span><br><span class="line"><span class="keyword">const</span> Reward = <span class="number">12.5</span></span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCoinBaseTX</span><span class="params">(miner <span class="type">string</span>, data <span class="type">string</span>)</span></span> *Transaction &#123;</span><br><span class="line"></span><br><span class="line">	inputs := []TXInput&#123;</span><br><span class="line">		&#123;<span class="literal">nil</span>, <span class="number">-1</span>, <span class="literal">nil</span>, []<span class="type">byte</span>(data)&#125;, <span class="comment">// 设置特殊的值来表示该交易为挖矿交易</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// outputs := []TXOutput&#123;</span></span><br><span class="line">	<span class="comment">// 	&#123;12.5, miner&#125;,</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	output := NewTXOutput(Reward, miner)</span><br><span class="line">	outputs := []TXOutput&#123;output&#125;</span><br><span class="line"></span><br><span class="line">	tx := Transaction&#123;<span class="literal">nil</span>, inputs, outputs&#125;</span><br><span class="line">	tx.SetTXID()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;tx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="改写-NewTransaction">改写 NewTransaction</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTransaction</span><span class="params">(from, to <span class="type">string</span>, amount <span class="type">float64</span>, bc *BlockChain)</span></span> *Transaction &#123;</span><br><span class="line">	<span class="comment">// 打开钱包</span></span><br><span class="line">	ws := NewWallets()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取密钥对</span></span><br><span class="line">	wallet := ws.WalletsMap[from]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> wallet == <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%s 的私钥不存在,交易创建失败!\n&quot;</span>, from)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取公钥、私钥</span></span><br><span class="line">	<span class="comment">// privateKey := wallet.PrivateKey 暂时不使用，在签名时才会使用</span></span><br><span class="line">	publicKey := wallet.PublicKey</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 获取公钥哈希方法</span></span><br><span class="line">	publicKeyHash := hashPublicKeyHash(from)</span><br><span class="line"></span><br><span class="line">	utxos := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">int64</span>) <span class="comment">// 标识能用的utxo</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> resValue <span class="type">float64</span> <span class="comment">// 这些utxo存储的金额</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 遍历账本，找到属于付款人的合适的金额的 `outputs`</span></span><br><span class="line">	utxos, resValue = bc.FindNeedUtxo(publicKeyHash, amount)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 如果金额不足以转账，则创建交易失败</span></span><br><span class="line">	<span class="keyword">if</span> resValue &lt; amount &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;余额不足，交易失败!\n&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 将 `outputs` 转成 `inputs`</span></span><br><span class="line">	<span class="keyword">var</span> inputs []TXInput</span><br><span class="line">	<span class="keyword">var</span> outputs []TXOutput</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> txid, indexes := <span class="keyword">range</span> utxos &#123;</span><br><span class="line">		<span class="keyword">for</span> _, i := <span class="keyword">range</span> indexes &#123;</span><br><span class="line">			input := TXInput&#123;[]<span class="type">byte</span>(txid), i, <span class="literal">nil</span>, publicKey&#125;</span><br><span class="line">			inputs = <span class="built_in">append</span>(inputs, input)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 创建输出，创建一个属于收款人的 `output`</span></span><br><span class="line">	<span class="comment">// output := TXOutput&#123;amount, to&#125;</span></span><br><span class="line">	output := NewTXOutput(amount, to)</span><br><span class="line">	outputs = <span class="built_in">append</span>(outputs, output)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 如果有找零则创建一个属于付款人的 `output`</span></span><br><span class="line">	<span class="keyword">if</span> resValue &gt; amount &#123;</span><br><span class="line">		<span class="comment">// output = TXOutput&#123;resValue - amount, from&#125;</span></span><br><span class="line">		output := NewTXOutput(resValue-amount, from)</span><br><span class="line">		outputs = <span class="built_in">append</span>(outputs, output)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 创建交易</span></span><br><span class="line">	tx := Transaction&#123;<span class="literal">nil</span>, inputs, outputs&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 设置交易 `ID`</span></span><br><span class="line">	tx.SetTXID()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// - 返回交易结构</span></span><br><span class="line">	<span class="keyword">return</span> &amp;tx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="改写-GetAddress-函数">改写 GetAddress 函数</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 给该结构提供一个 `GetAddress` 方法通过公钥获取地址</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *WalletKeyPair)</span></span> GetAddress() <span class="type">string</span> &#123;</span><br><span class="line">	publicHash := HashPublicKey(w.PublicKey)</span><br><span class="line"></span><br><span class="line">	version := <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 21字节的数据</span></span><br><span class="line">	payload := <span class="built_in">append</span>([]<span class="type">byte</span>&#123;<span class="type">byte</span>(version)&#125;, publicHash...)</span><br><span class="line"></span><br><span class="line">	checksum := CheckSum(payload)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 25字节数据</span></span><br><span class="line">	payload = <span class="built_in">append</span>(payload, checksum...)</span><br><span class="line"></span><br><span class="line">	address := base58.Encode(payload)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> address</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HashPublicKey</span><span class="params">(publicKey []<span class="type">byte</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	hash := sha256.Sum256(publicKey)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个hash160对象</span></span><br><span class="line">	<span class="comment">// 向hash160中write数据</span></span><br><span class="line">	rip160Hasher := ripemd160.New()</span><br><span class="line"></span><br><span class="line">	_, err := rip160Hasher.Write(hash[:])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sum appends the current hash to b and returns the resulting slice.</span></span><br><span class="line">	<span class="comment">// It does not change the underlying hash state.</span></span><br><span class="line">	<span class="comment">// Sum(b []byte) []byte</span></span><br><span class="line">	publicHash := rip160Hasher.Sum(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> publicHash</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckSum</span><span class="params">(payLoad []<span class="type">byte</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	first := sha256.Sum256(payLoad)</span><br><span class="line">	second := sha256.Sum256(first[:])</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4字节校验码</span></span><br><span class="line">	checksum := second[<span class="number">0</span>:<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> checksum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="改写-GetBalance">改写 GetBalance</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> GetBalance(address <span class="type">string</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 25字节</span></span><br><span class="line">	<span class="comment">// 这个过程不要打开钱包，因为有可能查看余额的人不是地址本人</span></span><br><span class="line">	decodeInfo := base58.Decode(address)</span><br><span class="line"></span><br><span class="line">	puclicKeyHash := decodeInfo[<span class="number">1</span> : <span class="built_in">len</span>(decodeInfo)<span class="number">-4</span>]</span><br><span class="line"></span><br><span class="line">	utxoInfos := bc.FindMyUtxos(puclicKeyHash)</span><br><span class="line"></span><br><span class="line">	total := <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 所有的output都在utxoInfos内部，获取余额只需遍历utxoInfos获取output即可</span></span><br><span class="line">	<span class="keyword">for</span> _, utxoInfo := <span class="keyword">range</span> utxoInfos &#123;</span><br><span class="line">		total += utxoInfo.Output.Value <span class="comment">// 剩余总额</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s 的余额为： %f\n&quot;</span>, address, total)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="地址有效性校验">地址有效性校验</h4>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 地址校验</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsValidAddress</span><span class="params">(address <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="comment">// 将输入的地址进行解码，得到25字节</span></span><br><span class="line">	decodeInfo := base58.Decode(address)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(decodeInfo) != <span class="number">25</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 取出前21个字节，运行CheckSum函数，得到checksum1</span></span><br><span class="line">	payLoad := decodeInfo[<span class="number">0</span> : <span class="built_in">len</span>(decodeInfo)<span class="number">-4</span>]</span><br><span class="line">	checksum1 := CheckSum(payLoad)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 取出后四个字节，得到checksum2</span></span><br><span class="line">	checksum2 := decodeInfo[<span class="built_in">len</span>(decodeInfo)<span class="number">-4</span>:]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 比较checksum1与checksum2。相同，则地址有效，否则无效</span></span><br><span class="line">	<span class="keyword">return</span> bytes.Equal(checksum1, checksum2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="交易签名校验">交易签名校验</h3>
<h4 id="私钥签名">私钥签名</h4>
<blockquote>
<h4 id="创建交易时使用私钥对交易进行签名">创建交易时使用私钥对交易进行签名</h4>
<p>对某笔交易进行签名，要填充每一个 <code>input</code> 的 <code>sig</code>，<code>N</code> 个 <code>input</code> 要有 <code>N</code> 个签名</p>
<p>签名内容包括：</p>
<ul>
<li>
<p>所引用的 <code>output</code> 的公钥哈希</p>
</li>
<li>
<p>新生成的 <code>output</code> 的公钥哈希</p>
</li>
<li>
<p>新生成的 <code>output</code> 的 <code>value</code></p>
</li>
</ul>
<p>签名时需要找到这个 <code>input</code> 对应的 <code>output</code>，即找到这笔交易</p>
<p>在创建交易最后对交易进行一次签名即可</p>
</blockquote>
<blockquote>
<h6 id="小问题">小问题</h6>
<p>将所引用的 <code>output</code> 放到 <code>input</code> 的 <code>publickey</code> 会覆盖原有的 <code>input</code> 的 <code>publickey</code> 吗？</p>
<ul>
<li>不会，在做签名的时候，会创建要给 <code>tx</code> 的副本，对这个副本进行替换，生成的 <code>Sig</code> 放回到原始的交易中，这样这个交易的所有字段就都完整了</li>
</ul>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cdn.jsdelivr.net/gh/coderlubo/blogimages@main/images/2023/03/01/5e01e4077f42eaf82f08c54993355451-%E7%AD%BE%E5%90%8D%E8%AF%A6%E7%BB%86%E5%9B%BE%E7%A4%BA-6cddc8.png"
                      alt=""
                ></p>
<h5 id="bc-SignTranaction">bc.SignTranaction</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> SignTransaction(tx *Transaction, privateKey *ecdsa.PrivateKey) &#123;</span><br><span class="line">	<span class="comment">// 遍历账本找到所有交易</span></span><br><span class="line">	prevTXs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Transaction)</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line"></span><br><span class="line">	tx.Sign(privateKey, prevTXs)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在-Transaction-go-中添加签名函数">在 Transaction.go 中添加签名函数</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一个参数是私钥</span></span><br><span class="line"><span class="comment">// 第二个参数是这个交易的input所引用的所有交易</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Transaction)</span></span> Sign(privateKey *ecdsa.PrivateKey, prevTXs <span class="keyword">map</span>[<span class="type">string</span>]Transaction) &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;对交易进行签名...\n&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在-NewTransaction-最后调用">在 NewTransaction 最后调用</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 付款人在创建交易时，已经得到了所有引用的output的详细信息，</span></span><br><span class="line"><span class="comment">// 但在这里不会使用，因为矿工在校验的时候，矿工时没有这部分信息的，矿工需要遍历账本找到所有的交易</span></span><br><span class="line"><span class="comment">// 把查找引用交易的环节放到BlockChain中，同时在BlockChain中进行调用签名</span></span><br><span class="line">bc.SignTransaction(&amp;tx, privateKey)</span><br></pre></td></tr></table></figure></div>
<h5 id="实现-SignTransaction函数">实现 SignTransaction函数</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> SignTransaction(tx *Transaction, privateKey *ecdsa.PrivateKey) &#123;</span><br><span class="line">	<span class="comment">// 遍历账本找到所有交易</span></span><br><span class="line">	prevTXs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Transaction)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 遍历tx的inputs,通过id取查找所引用的交易</span></span><br><span class="line">	<span class="keyword">for</span> _, input := <span class="keyword">range</span> tx.TXInputs &#123;</span><br><span class="line">		prevTX := bc.FindTransaction(input.TXID)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> prevTX == <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;没有找到交易: %x\n&quot;</span>, input.TXID)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 把找到的引用交易保存起来</span></span><br><span class="line">			prevTXs[<span class="type">string</span>(input.TXID)] = prevTX</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tx.Sign(privateKey, prevTXs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="实现-FindTransaction">实现 FindTransaction</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> FindTransaction(TXID []<span class="type">byte</span>) *Transaction &#123;</span><br><span class="line">	<span class="comment">// 遍历区块链的交易</span></span><br><span class="line">	it := bc.NewIterator()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := it.Next()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> block.Transactions &#123;</span><br><span class="line">			<span class="comment">// 对比id来识别，如果找到相同id交易，直接返回交易即可</span></span><br><span class="line">			<span class="keyword">if</span> bytes.Equal(tx.TXID, TXID) &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;找到了所引用的交易: %x\n&quot;</span>, TXID)</span><br><span class="line">				<span class="keyword">return</span> tx</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(block.PrevBlockHash) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="校验">校验</h4>
<blockquote>
<p>打包交易之前对交易进行校验</p>
</blockquote>
<h5 id="实现VerifyTransaction函数">实现VerifyTransaction函数</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 矿工校验流程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> VerifyTransaction(tx *Transaction) <span class="type">bool</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 校验时，挖矿交易直接返回true</span></span><br><span class="line">	<span class="keyword">if</span> tx.IsCoinbase() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.找到交易input所引用的所有交易prevTxs</span></span><br><span class="line">	prevTXs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Transaction)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 遍历tx的inputs,通过id取查找所引用的交易</span></span><br><span class="line">	<span class="keyword">for</span> _, input := <span class="keyword">range</span> tx.TXInputs &#123;</span><br><span class="line">		prevTX := bc.FindTransaction(input.TXID)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> prevTX == <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;没有找到交易: %x\n&quot;</span>, input.TXID)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 把找到的引用交易保存起来</span></span><br><span class="line">			prevTXs[<span class="type">string</span>(input.TXID)] = *prevTX</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2.对交易进行校验</span></span><br><span class="line">	<span class="keyword">return</span> tx.Verify(prevTXs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在-Transaction中添加Verify空实现">在 Transaction中添加Verify空实现</h5>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func (tx *Transaction) Verify(prevTXs <span class="built_in">map</span>[<span class="built_in">string</span>]Transaction) <span class="type">bool</span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;对交易进行校验...\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="在AddBlock中对交易进行校验">在AddBlock中对交易进行校验</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span></span> AddBlock(txs []*Transaction) &#123;</span><br><span class="line">	<span class="comment">// 矿工在得到一个交易时，要在第一时间对交易进行验证</span></span><br><span class="line">	<span class="comment">// 矿工如果不验证，即是挖矿成功，广播区块后，其他的验证矿工仍然会校验每一笔交易</span></span><br><span class="line">	validTXs := []*Transaction&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, tx := <span class="keyword">range</span> txs &#123;</span><br><span class="line">		<span class="keyword">if</span> bc.VerifyTransaction(tx) &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;该交易有效: %x\n&quot;</span>, tx.TXID)</span><br><span class="line">			validTXs = <span class="built_in">append</span>(validTXs, tx)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;发现无效交易: %x\n&quot;</span>, tx.TXID)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="Sig签名函数实现">Sig签名函数实现</h4>
<blockquote>
<ol>
<li>
<p>拷贝一份交易</p>
<ul>
<li>
<p>做相应的裁剪:将每个input的Sig和input设置为nil</p>
</li>
<li>
<p>output不做修改</p>
</li>
</ul>
</li>
<li>
<p>遍历txCopy.inputs，将inputs所引用的output的公钥哈希拿过来，赋值给pubkey</p>
</li>
<li>
<p>生成要签名的数据(哈希)</p>
</li>
<li>
<p>对数据进行签名r，s</p>
</li>
<li>
<p>拼接r，s为字节流，赋值给原始交易的Signature字段</p>
</li>
</ol>
</blockquote>
<h5 id="TrimmedCopy函数实现">TrimmedCopy函数实现</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.拷贝一份交易</span></span><br><span class="line"><span class="comment">// &gt; 做相应的裁剪:将每个input的Sig和input设置为nil</span></span><br><span class="line"><span class="comment">// &gt; output不做修改</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Transaction)</span></span> TrimmedCopy() Transaction &#123;</span><br><span class="line">	<span class="keyword">var</span> inputs []TXInput</span><br><span class="line">	<span class="keyword">var</span> outputs []TXOutput</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, input := <span class="keyword">range</span> tx.TXInputs &#123;</span><br><span class="line">		input1 := TXInput&#123;input.TXID, input.Index, <span class="literal">nil</span>, <span class="literal">nil</span>&#125;</span><br><span class="line">		inputs = <span class="built_in">append</span>(inputs, input1)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outputs = tx.TXOutputs</span><br><span class="line"></span><br><span class="line">	tx1 := Transaction&#123;tx.TXID, inputs, outputs&#125;</span><br><span class="line">	<span class="keyword">return</span> tx1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="Sign-函数实现">Sign 函数实现</h5>
<div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一个参数是私钥</span></span><br><span class="line"><span class="comment">// 第二个参数是这个交易的input所引用的所有交易</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Transaction)</span></span> Sign(privateKey *ecdsa.PrivateKey, prevTXs <span class="keyword">map</span>[<span class="type">string</span>]Transaction) &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;对交易进行签名...\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1.拷贝一份交易</span></span><br><span class="line">	<span class="comment">// &gt; 做相应的裁剪:将每个input的Sig和input设置为nil</span></span><br><span class="line">	<span class="comment">// &gt; output不做修改</span></span><br><span class="line">	txCopy := tx.TrimmedCopy()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2.遍历txCopy.inputs,将inputs所引用的output的公钥哈希拿过来，赋值给pubkey</span></span><br><span class="line">	<span class="keyword">for</span> i, input := <span class="keyword">range</span> txCopy.TXInputs &#123;</span><br><span class="line">		<span class="comment">// 找到引用的交易</span></span><br><span class="line">		prevTX := prevTXs[<span class="type">string</span>(input.TXID)]</span><br><span class="line">		output := prevTX.TXOutputs[input.Index]</span><br><span class="line"></span><br><span class="line">		<span class="comment">// for循环迭代器迭代出来的数据是一个副本，对该元素修改不会影响到原始数据</span></span><br><span class="line">		<span class="comment">// input.PublicKey = output.PublicKeyHash</span></span><br><span class="line">		txCopy.TXInputs[i].PublicKey = output.PublicKeyHash</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 签名要对数据的hash进行签名</span></span><br><span class="line">		<span class="comment">// 数据都在交易中，求交易的哈希</span></span><br><span class="line">		<span class="comment">// Transaction的SetTXID函数就是对交易的哈希</span></span><br><span class="line">		<span class="comment">// 使用交易id作为签名的内容</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3.生成要签名的数据(哈希)</span></span><br><span class="line">		txCopy.SetTXID()</span><br><span class="line">		signData := txCopy.TXID</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 清理</span></span><br><span class="line">		<span class="comment">// input.PublicKey = nil</span></span><br><span class="line">		txCopy.TXInputs[i].PublicKey = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;要签名的数据:SignData:%x\n&quot;</span>, signData)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.对数据进行签名得到r,s</span></span><br><span class="line">		r, s, err := ecdsa.Sign(rand.Reader, privateKey, signData)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;交易签名失败, err: %v\n&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 5.拼接r,s为字节流，赋值给原始交易的Signature字段</span></span><br><span class="line">		signature := <span class="built_in">append</span>(r.Bytes(), s.Bytes()...)</span><br><span class="line">		tx.TXInputs[i].Signalture = signature</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li>Post title：区块链技术</li>
        <li>Post author：Lubo</li>
        <li>Create time：2021-08-08 10:25:57</li>
        <li>
            Post link：https://coderlubo.github.io/posts/45868/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/Blockchain/">#Blockchain</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/btc/">#btc</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/posts/1106/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">数据结构</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/posts/35593/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">密码学</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">区块链技术</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-text">比特币</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link"><span class="nav-text">2021年8月8日</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">一、概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%BA%E7%B1%BB%E4%BA%A4%E6%98%93%E5%8F%91%E5%B1%95%E5%8F%B2"><span class="nav-text">人类交易发展史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E8%AF%9E%E7%94%9F"><span class="nav-text">比特币诞生</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E6%9C%AC%E8%81%AA"><span class="nav-text">中本聪</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E5%BF%83%E5%8C%96%E5%92%8C%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96"><span class="nav-text">中心化和去中心化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%AD%E5%BF%83%E5%8C%96%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">中心化存在的问题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96"><span class="nav-text">去中心化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">比特币客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%AF%94%E7%89%B9%E5%B8%81%E7%AE%80%E4%BB%8B"><span class="nav-text">二、比特币简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-text">概述</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E7%9A%84%E8%AE%B0%E8%B4%A6%E6%96%B9%E5%BC%8F"><span class="nav-text">比特币的记账方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%B1%E5%8C%85"><span class="nav-text">钱包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%85%AC%E9%92%A5%E3%80%81%E7%A7%81%E9%92%A5%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%A7%81%E9%92%A5%EF%BC%8C%E7%9B%B8%E5%BD%93%E4%BA%8E%E9%92%B1%E5%8C%85%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%AD%98%E6%94%BE%E5%A4%9A%E4%B8%AA%E5%9C%B0%E5%9D%80"><span class="nav-text">创建公钥、私钥，保存私钥，相当于钱包，可以存放多个地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9"><span class="nav-text">节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%8F%E4%B8%80%E4%B8%AA%E8%BF%90%E8%A1%8C%E6%8C%96%E7%9F%BF%E8%BD%AF%E4%BB%B6%E7%9A%84%E4%BA%BA%E5%8F%98%E6%88%90%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BD%91%E7%BB%9C%E7%9A%84%E8%8A%82%E7%82%B9"><span class="nav-text">每一个运行挖矿软件的人变成为一个区块链网络的节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%A6%E6%9C%AC"><span class="nav-text">账本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%96%E7%9F%BF"><span class="nav-text">挖矿</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-text">三个问题</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8C%96%E7%9F%BF%E6%9C%AC%E8%B4%A8"><span class="nav-text">挖矿本质</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%9A%BE%E5%BA%A6%E5%80%BC"><span class="nav-text">难度值</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0"><span class="nav-text">系统参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BA%E5%9D%97%E6%97%B6%E9%97%B4"><span class="nav-text">出块时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E6%80%BB%E9%87%8F"><span class="nav-text">比特币总量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BA%E5%9D%97%E5%A5%96%E5%8A%B1%E5%88%9D%E5%A7%8B%E5%80%BC%E4%B8%BA-50%EF%BC%8C%E6%AF%8F%E6%8C%96%E5%87%BA21%E4%B8%87%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%B0%B1%E5%87%8F%E5%8D%8A%E4%B8%80%E6%AC%A1"><span class="nav-text">出块奖励初始值为 50，每挖出21万个区块就减半一次</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E5%AE%B9%E9%87%8F"><span class="nav-text">区块容量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%80%83%E8%99%91%E5%90%8C%E6%AD%A5%E6%95%88%E7%8E%87"><span class="nav-text">考虑同步效率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%8F%E7%A7%92%E6%88%90%E4%BA%A4%E9%87%8F"><span class="nav-text">每秒成交量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E4%BD%8D"><span class="nav-text">单位</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E8%BD%AC%E8%B4%A6%E6%B5%81%E7%A8%8B"><span class="nav-text">比特币转账流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E4%BE%9D%E8%B5%96%E6%8A%80%E6%9C%AF"><span class="nav-text">比特币依赖技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E5%AD%A6"><span class="nav-text">密码学</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="nav-text">对称加密</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%87%E7%94%A8%E5%8D%95%E9%92%A5%E5%AF%86%E7%A0%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%8A%A0%E5%AF%86%E6%96%B9%E6%B3%95%EF%BC%8C%E5%90%8C%E4%B8%80%E4%B8%AA%E5%AF%86%E9%92%A5%E5%8F%AF%E4%BB%A5%E5%90%8C%E6%97%B6%E7%94%A8%E4%BD%9C%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A0%E5%AF%86%E5%92%8C%E8%A7%A3%E5%AF%86%EF%BC%8C%E8%BF%99%E7%A7%8D%E5%8A%A0%E5%AF%86%E6%96%B9%E6%B3%95%E7%A7%B0%E4%B8%BA%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%EF%BC%8C%E4%B9%9F%E7%A7%B0%E4%B8%BA%E5%8D%95%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86"><span class="nav-text">采用单钥密码系统的加密方法，同一个密钥可以同时用作信息的加密和解密，这种加密方法称为对称加密，也称为单密钥加密</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AE%97%E6%B3%95"><span class="nav-text">算法</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%89%B9%E7%82%B9"><span class="nav-text">特点</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="nav-text">非对称加密</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5%E4%B8%80%E4%B8%80%E5%AF%B9%E5%BA%94%EF%BC%8C%E5%85%AC%E9%92%A5%E8%B4%9F%E8%B4%A3%E5%8A%A0%E5%AF%86%EF%BC%8C%E5%AF%B9%E5%A4%96%E5%85%AC%E5%BC%80%EF%BC%8C%E7%A7%81%E9%92%A5%E7%94%A8%E4%BA%8E%E5%8A%A0%E5%AF%86%E5%92%8C%E7%AD%BE%E5%90%8D%EF%BC%8C%E4%BB%85%E8%87%AA%E5%B7%B1%E6%8C%81%E6%9C%89%EF%BC%8C%E5%86%B3%E4%B8%8D%E8%83%BD%E5%A4%96%E6%BC%8F"><span class="nav-text">公钥私钥一一对应，公钥负责加密，对外公开，私钥用于加密和签名，仅自己持有，决不能外漏</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-2"><span class="nav-text">特点</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AE%97%E6%B3%95-2"><span class="nav-text">算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#P2P%E7%BD%91%E7%BB%9C"><span class="nav-text">P2P网络</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#P2P-peer-to-peer-%E7%82%B9%E5%AF%B9%E7%82%B9%E6%8A%80%E6%9C%AF%EF%BC%8C%E6%97%A0%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E4%BE%9D%E9%9D%A0%E7%94%A8%E6%88%B7%E7%BE%A4%E4%BA%A4%E6%8D%A2%E4%BF%A1%E6%81%AF%E7%9A%84%E4%BA%92%E8%81%94%E7%BD%91%E4%BD%93%E7%B3%BB"><span class="nav-text">P2P(peer-to-peer):点对点技术，无中心服务器，依靠用户群交换信息的互联网体系</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-3"><span class="nav-text">特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E"><span class="nav-text">工作量证明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E5%9C%B0%E5%9D%80%E7%94%9F%E6%88%90"><span class="nav-text">比特币地址生成</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E9%9A%8F%E6%9C%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E8%A1%8C%E5%93%88%E5%B8%8C%EF%BC%8C%E7%94%9F%E6%88%9032%E5%AD%97%E8%8A%82%E7%9A%84%E7%A7%81%E9%92%A5"><span class="nav-text">对随机字符串进行哈希，生成32字节的私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E7%BB%93%E6%9E%84"><span class="nav-text">区块结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E5%A4%B4"><span class="nav-text">区块头</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E4%B8%8D%E5%AD%98%E5%82%A8-hash-%E5%80%BC%EF%BC%8C%E8%8A%82%E7%82%B9%E6%8E%A5%E6%94%B6%E5%8C%BA%E5%9D%97%E5%90%8E%E7%8B%AC%E7%AB%8B%E8%AE%A1%E7%AE%97%E5%B9%B6%E5%AD%98%E5%82%A8%E5%9C%A8%E6%9C%AC%E5%9C%B0"><span class="nav-text">区块不存储 hash 值，节点接收区块后独立计算并存储在本地</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E6%9C%AC%E8%BA%AB%E4%B8%8D%E5%AD%98%E5%82%A8%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E5%93%88%E5%B8%8C%E5%80%BC%EF%BC%8C%E8%80%8C%E6%98%AF%E8%8A%82%E7%82%B9%E6%8E%A5%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97%E5%90%8E%EF%BC%8C%E5%9C%A8%E6%9C%AC%E5%9C%B0%E8%87%AA%E5%B7%B1%E8%AE%A1%E7%AE%97%E5%87%BA%E7%9B%B8%E5%BA%94%E7%9A%84-hash"><span class="nav-text">区块本身不存储当前区块的哈希值，而是节点接收到区块后，在本地自己计算出相应的 hash</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E4%BD%93%EF%BC%88Transactions%EF%BC%89"><span class="nav-text">区块体（Transactions）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Coinbase-%E4%BA%A4%E6%98%93"><span class="nav-text">Coinbase 交易</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E8%BD%AC%E8%B4%A6%E4%BA%A4%E6%98%93"><span class="nav-text">普通转账交易</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-text">三、代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#v1-%E7%89%88%E6%9C%AC"><span class="nav-text">v1 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%A5%E7%89%88%E6%9C%AC%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">该版本存在的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%89%93%E5%8D%B0%E5%8C%BA%E5%9D%97"><span class="nav-text">定义区块，创建区块，打印区块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-setHash-%E5%87%BD%E6%95%B0"><span class="nav-text">实现 setHash 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%AE%9A%E4%B9%89%E5%8F%8A%E4%BD%BF%E7%94%A8"><span class="nav-text">区块链的定义及使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%8C%BA%E5%9D%97"><span class="nav-text">添加区块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E9%87%8D%E6%9E%84"><span class="nav-text">代码重构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%E5%8C%BA%E5%9D%97%E5%AD%97%E6%AE%B5"><span class="nav-text">补充区块字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-NewBlock-%E5%87%BD%E6%95%B0"><span class="nav-text">更新 NewBlock 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-setHash-%E5%87%BD%E6%95%B0"><span class="nav-text">更新 setHash 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%A9%BA%E5%87%BD%E6%95%B0-uintToByte"><span class="nav-text">添加空函数 uintToByte</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8%E5%B7%A5%E5%85%B7%E6%96%87%E4%BB%B6utils-go%E4%B8%AD%E6%B7%BB%E5%8A%A0"><span class="nav-text">在工具文件utils.go中添加</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E9%80%BB%E8%BE%91%E5%AE%9E%E7%8E%B0"><span class="nav-text">编码逻辑实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-bytes-join-%E6%94%B9%E5%86%99-setHash-%E5%87%BD%E6%95%B0"><span class="nav-text">使用 bytes.join 改写 setHash 函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#v2-%E7%89%88%E6%9C%AC"><span class="nav-text">v2 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF"><span class="nav-text">思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%A5%E7%89%88%E6%9C%AC%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98-2"><span class="nav-text">该版本存在的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POW-%E5%AE%9A%E4%B9%89"><span class="nav-text">POW 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">Run 函数实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-pow-%E6%9B%B4%E6%96%B0-NewBlock"><span class="nav-text">使用  pow 更新 NewBlock</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C%E6%8C%96%E7%9F%BF%E6%98%AF%E5%90%A6%E6%9C%89%E6%95%88"><span class="nav-text">校验挖矿是否有效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%93%E5%8D%B0-Block-%E5%AD%97%E6%AE%B5"><span class="nav-text">打印 Block 字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Bits-%E6%8E%A8%E5%AF%BC%E9%9A%BE%E5%BA%A6%E5%80%BC"><span class="nav-text">使用 Bits 推导难度值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#v3-%E7%89%88%E6%9C%AC"><span class="nav-text">v3 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="nav-text">思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bolt-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">bolt 数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90-Bolt-%E5%AD%98%E5%82%A8%E5%8C%BA%E5%9D%97%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="nav-text">分析 Bolt 存储区块的格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bolt-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Bolt 数据库在区块链中的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-text">结论</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99%E5%8C%BA%E5%9D%97%E9%93%BE-NewBlockChain-%E6%96%B9%E6%B3%95"><span class="nav-text">改写区块链 NewBlockChain 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gob-%E7%BC%96%E8%A7%A3%E7%A0%81"><span class="nav-text">gob 编解码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E3%80%81%E8%A7%A3%E7%A0%81"><span class="nav-text">编码、解码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-AddBlock"><span class="nav-text">更新 AddBlock</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-text">迭代器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-text">功能分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E3%80%81%E5%88%9B%E5%BB%BA%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-text">定义、创建迭代器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8-Next-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">迭代器 Next 函数实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%9B%B4%E6%96%B0-main-%E5%87%BD%E6%95%B0"><span class="nav-text">使用迭代器更新 main 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C-Demo"><span class="nav-text">命令行 Demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%88%86%E6%9E%90"><span class="nav-text">使用命令行分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%88%86%E6%9E%90"><span class="nav-text">命令行分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%94%B9%E5%86%99-main-%E5%87%BD%E6%95%B0"><span class="nav-text">改写 main 函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-Run-%E5%87%BD%E6%95%B0"><span class="nav-text">更新 Run 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-commands-go-%E6%96%87%E4%BB%B6"><span class="nav-text">添加 commands.go 文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BA%A4%E6%98%93"><span class="nav-text">四、交易</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E7%BB%AD%E8%B4%B9"><span class="nav-text">手续费</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AC%E8%B4%A6"><span class="nav-text">转账</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E8%BD%AC%E8%B4%A6"><span class="nav-text">一对多转账</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E4%B8%80%E8%BD%AC%E8%B4%A6"><span class="nav-text">多对一转账</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E5%BD%A2%E5%BC%8F"><span class="nav-text">比特币中的交易形式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E4%BA%A4%E6%98%93%EF%BC%88%E6%89%BE%E9%9B%B6%EF%BC%89"><span class="nav-text">普通交易（找零）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E4%B8%80%EF%BC%88%E5%87%91%E9%9B%B6%E9%92%B1%E4%BB%98%E8%B4%A6%EF%BC%89"><span class="nav-text">多对一（凑零钱付账）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%EF%BC%88%E4%BB%A3%E5%8F%91%E5%B7%A5%E8%B5%84%EF%BC%89"><span class="nav-text">一对多（代发工资）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%EF%BC%88%E5%A4%A7%E9%A2%9D%E6%94%AF%E4%BB%98-%E6%89%BE%E9%9B%B6%EF%BC%89"><span class="nav-text">多对多（大额支付+找零）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E6%B5%81%E7%A8%8B"><span class="nav-text">交易流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%93%E5%87%BA%E4%BA%A7%E7%94%9F%E6%B5%81%E7%A8%8B"><span class="nav-text">输出产生流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%AC%E8%B4%A6%E5%8F%91%E8%B5%B7%E6%97%B6%EF%BC%8C%E6%AF%94%E7%89%B9%E5%B8%81%E7%B3%BB%E7%BB%9F%E4%BC%9A%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA-Output"><span class="nav-text">转账发起时，比特币系统会生成一个 Output</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%93%E5%85%A5%E4%BA%A7%E7%94%9F%E6%B5%81%E7%A8%8B"><span class="nav-text">输入产生流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%8F%E4%B8%80%E4%B8%AA-input-%E9%83%BD%E6%BA%90%E4%BA%8E%E4%B8%80%E4%B8%AA-Output"><span class="nav-text">每一个 input 都源于一个 Output</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C%E8%84%9A%E6%9C%AC"><span class="nav-text">校验脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%94%81%E5%AE%9A%E8%84%9A%E6%9C%AC"><span class="nav-text">锁定脚本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E9%94%81%E8%84%9A%E6%9C%AC"><span class="nav-text">解锁脚本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C%E4%BA%A4%E6%98%93"><span class="nav-text">校验交易</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UTXO"><span class="nav-text">UTXO</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AA%E6%B6%88%E8%B4%B9%E8%BE%93%E5%87%BA%EF%BC%88UTXO%EF%BC%8CUnspent-Transaction-Output%EF%BC%89"><span class="nav-text">未消费输出（UTXO，Unspent Transaction Output）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#UTXO-%E6%B5%81%E7%A8%8B%E6%BC%94%E7%A4%BA-%E6%BC%94%E7%A4%BA"><span class="nav-text">UTXO 流程演示 演示</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E7%BB%93%E6%9E%84"><span class="nav-text">交易结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%EF%BC%88TXInput%EF%BC%89"><span class="nav-text">交易输入（TXInput）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E6%98%8E%E4%BA%A4%E6%98%93%E5%8F%91%E8%B5%B7%E4%BA%BA%E5%8F%AF%E6%94%AF%E4%BB%98%E8%B5%84%E9%87%91%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="nav-text">指明交易发起人可支付资金的来源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E8%BE%93%E5%87%BA%EF%BC%88TXOutput%EF%BC%89"><span class="nav-text">交易输出（TXOutput）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%85%E5%90%AB%E8%B5%84%E9%87%91%E6%8E%A5%E6%94%B6%E6%96%B9%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="nav-text">包含资金接收方的相关信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%98%93ID"><span class="nav-text">交易ID</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81V4-%E7%89%88%E6%9C%AC"><span class="nav-text">五、V4 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E7%BB%93%E6%9E%84%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">交易结构的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SetTXID-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">SetTXID 函数实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%96%E7%9F%BF%E4%BA%A4%E6%98%93%E5%AE%9E%E7%8E%B0"><span class="nav-text">挖矿交易实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Transaction-%E6%94%B9%E5%86%99%E7%A8%8B%E5%BA%8F"><span class="nav-text">使用 Transaction 改写程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E9%BB%98%E5%85%8B%E5%B0%94%E6%A0%B9"><span class="nav-text">模拟默克尔根</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E4%B8%AD%E5%81%9A%E5%93%88%E5%B8%8C%EF%BC%8C%E5%B9%B6%E4%B8%8D%E6%98%AF%E5%AF%B9%E6%95%B4%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%81%9A%E5%93%88%E5%B8%8C%EF%BC%8C%E8%80%8C%E6%98%AF%E5%AF%B9%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%81%9A%E5%93%88%E5%B8%8C"><span class="nav-text">比特币中做哈希，并不是对整个区块做哈希，而是对区块头做哈希</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%A9%E4%BD%99%E6%AF%94%E7%89%B9%E5%B8%81%E8%AE%A1%E7%AE%97"><span class="nav-text">剩余比特币计算</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="nav-text">实现思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-cli-go-%E4%B8%AD%E6%B7%BB%E5%8A%A0-GetBalance-%E5%91%BD%E4%BB%A4%EF%BC%8C%E8%B0%83%E7%94%A8-GetBalance-%E6%96%B9%E6%B3%95"><span class="nav-text">在 cli.go 中添加 GetBalance 命令，调用 GetBalance 方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link"><span class="nav-text"></span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%81%8D%E5%8E%86%E4%BA%A4%E6%98%93%E8%BE%93%E5%87%BA-TXOutputs"><span class="nav-text">遍历交易输出 TXOutputs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%81%8D%E5%8E%86%E4%BA%A4%E6%98%93%E7%9A%84-Inputs"><span class="nav-text">遍历交易的 Inputs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E8%AF%86%E4%BD%BF%E7%94%A8%E8%BF%87%E7%9A%84-Output-%E9%9C%80%E8%A6%81%E4%B8%A4%E4%B8%AA%E6%95%B0%E6%8D%AE"><span class="nav-text">标识使用过的 Output 需要两个数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E9%81%8D%E5%8E%86%E8%BF%87%E7%A8%8B"><span class="nav-text">整体遍历过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%99%AE%E9%80%9A%E4%BA%A4%E6%98%93"><span class="nav-text">创建普通交易</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FindNeedUtxo"><span class="nav-text">FindNeedUtxo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#send-%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0"><span class="nav-text">send 命令实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-send-%E5%91%BD%E4%BB%A4"><span class="nav-text">添加 send 命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FindMyUtxos-%E4%B8%8E-FindNeedUtxo-%E6%95%B4%E5%90%88"><span class="nav-text">FindMyUtxos 与 FindNeedUtxo 整合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#UTXOInfo"><span class="nav-text">UTXOInfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-UTXOInfo-%E7%BB%93%E6%9E%84%E3%80%82%E5%90%8C%E6%97%B6%E5%8C%85%E5%90%AB-output-%E5%B7%B2%E7%BB%8F%E5%AE%9A%E4%BD%8D%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="nav-text">定义 UTXOInfo 结构。同时包含 output 已经定位的信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-FindMyUtxos"><span class="nav-text">改写 FindMyUtxos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-Getbalance"><span class="nav-text">改写 Getbalance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-FindNeedUtxo"><span class="nav-text">改写 FindNeedUtxo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BD%99%E6%93%8D%E4%BD%9C"><span class="nav-text">其余操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IsCoinbase"><span class="nav-text">IsCoinbase</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8%E9%81%8D%E5%8E%86-Inputs-%E6%97%B6%E4%BD%BF%E7%94%A8"><span class="nav-text">在遍历 Inputs 时使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%88%9B%E5%BB%BA%E5%8C%BA%E5%9D%97%E9%93%BE%E5%91%BD%E4%BB%A4"><span class="nav-text">添加创建区块链命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%8C%BA%E5%9D%97%E9%93%BE%E5%87%BD%E6%95%B0"><span class="nav-text">创建区块链函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E4%BE%8B%E5%87%BD%E6%95%B0"><span class="nav-text">获取区块链实例函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-CreateBlockChain-%E5%91%BD%E4%BB%A4"><span class="nav-text">添加 CreateBlockChain 命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-cli-go-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%91%BD%E4%BB%A4"><span class="nav-text">在 cli.go 中添加命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0"><span class="nav-text">主函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8-commands-go-%E4%B8%AD%E8%B0%83%E7%94%A8-NewBlockChain-%E5%87%BD%E6%95%B0"><span class="nav-text">在 commands.go 中调用 NewBlockChain 函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E5%8C%BA%E5%9D%97%E9%93%BE%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-text">判断区块链文件是否存在</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A4%E6%96%AD-blockChain-db-%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-text">判断 blockChain.db 是否存在</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8-NewBlockChain-%E4%B8%AD%E8%B0%83%E7%94%A8"><span class="nav-text">在 NewBlockChain 中调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8-CreateBlockChain-%E4%B8%AD%E8%B0%83%E7%94%A8"><span class="nav-text">在 CreateBlockChain 中调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8-commands-go-%E4%B8%AD%E8%BF%9B%E8%A1%8C%E6%9C%89%E6%95%88%E6%80%A7%E5%88%A4%E6%96%AD"><span class="nav-text">在 commands.go 中进行有效性判断</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81V5-%E7%89%88%E6%9C%AC"><span class="nav-text">六、V5 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#V4-%E7%89%88%E6%9C%AC%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">V4 版本存在的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%AD%A5%E9%AA%A4"><span class="nav-text">解决步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ecdsa-%E7%AD%BE%E5%90%8D-demo"><span class="nav-text">ecdsa 签名 demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%E5%9C%B0%E5%9D%80"><span class="nav-text">生成新的比特币地址</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4"><span class="nav-text">步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%BB%93%E6%9E%84-WalletKeyPair-%E5%AF%86%E9%92%A5%E5%AF%B9"><span class="nav-text">创建一个结构 WalletKeyPair 密钥对</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%A8%E4%BA%8E%E4%BF%9D%E5%AD%98%E5%85%AC%E9%92%A5%E5%92%8C%E7%A7%81%E9%92%A5"><span class="nav-text">用于保存公钥和私钥</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NewWalletKeyPair-%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="nav-text">NewWalletKeyPair 方法实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GetAddress-%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="nav-text">GetAddress 方法实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%99-WalletKeyPait-%E7%BB%93%E6%9E%84%E6%8F%90%E4%BE%9B%E4%B8%80%E4%B8%AA-GetAddress-%E6%96%B9%E6%B3%95%E9%80%9A%E8%BF%87%E5%85%AC%E9%92%A5%E8%8E%B7%E5%8F%96%E5%9C%B0%E5%9D%80"><span class="nav-text">给 WalletKeyPait 结构提供一个 GetAddress 方法通过公钥获取地址</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E9%92%B1%E5%8C%85%E7%BB%93%E6%9E%84"><span class="nav-text">定义钱包结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%99%E6%98%AF%E5%AF%B9%E5%A4%96%E7%9A%84"><span class="nav-text">这是对外的</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E9%92%B1%E5%8C%85"><span class="nav-text">创建新的钱包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%92%B1%E5%8C%85%E5%AE%9E%E4%BE%8B"><span class="nav-text">获取钱包实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8"><span class="nav-text">调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E9%92%B1%E5%8C%85%E5%88%B0%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6"><span class="nav-text">保存钱包到本地文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F"><span class="nav-text">注意</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E4%B8%AD%E5%8A%A0%E8%BD%BD%E9%92%B1%E5%8C%85"><span class="nav-text">从本地文件中加载钱包</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-2"><span class="nav-text">注意</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E6%89%80%E6%9C%89%E9%92%B1%E5%8C%85%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="nav-text">打印所有钱包的地址</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E5%86%99%E7%A8%8B%E5%BA%8F"><span class="nav-text">改写程序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-TXInput-%E5%92%8C-TXOutput"><span class="nav-text">改写 TXInput 和 TXOutput</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TXOutput-%E6%8F%90%E4%BE%9B-Lock-%E6%96%B9%E6%B3%95"><span class="nav-text">TXOutput 提供 Lock 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%99%E5%AE%9A%E8%BD%AC%E8%B4%A6%E5%9C%B0%E5%9D%80%EF%BC%8C%E5%BE%97%E5%88%B0%E8%AF%A5%E5%9C%B0%E5%9D%80%E7%9A%84%E5%85%AC%E9%92%A5%E5%93%88%E5%B8%8C%EF%BC%8C%E5%AE%8C%E6%88%90%E5%AF%B9output%E7%9A%84%E9%94%81%E5%AE%9A"><span class="nav-text">给定转账地址，得到该地址的公钥哈希，完成对output的锁定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-TXOutput"><span class="nav-text">创建 TXOutput</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-NewCoinbaseTX"><span class="nav-text">改写 NewCoinbaseTX</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-NewTransaction"><span class="nav-text">改写 NewTransaction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-GetAddress-%E5%87%BD%E6%95%B0"><span class="nav-text">改写 GetAddress 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99-GetBalance"><span class="nav-text">改写 GetBalance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E6%9C%89%E6%95%88%E6%80%A7%E6%A0%A1%E9%AA%8C"><span class="nav-text">地址有效性校验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C"><span class="nav-text">交易签名校验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%81%E9%92%A5%E7%AD%BE%E5%90%8D"><span class="nav-text">私钥签名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%BA%A4%E6%98%93%E6%97%B6%E4%BD%BF%E7%94%A8%E7%A7%81%E9%92%A5%E5%AF%B9%E4%BA%A4%E6%98%93%E8%BF%9B%E8%A1%8C%E7%AD%BE%E5%90%8D"><span class="nav-text">创建交易时使用私钥对交易进行签名</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%B0%8F%E9%97%AE%E9%A2%98"><span class="nav-text">小问题</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bc-SignTranaction"><span class="nav-text">bc.SignTranaction</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8-Transaction-go-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%AD%BE%E5%90%8D%E5%87%BD%E6%95%B0"><span class="nav-text">在 Transaction.go 中添加签名函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8-NewTransaction-%E6%9C%80%E5%90%8E%E8%B0%83%E7%94%A8"><span class="nav-text">在 NewTransaction 最后调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-SignTransaction%E5%87%BD%E6%95%B0"><span class="nav-text">实现 SignTransaction函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-FindTransaction"><span class="nav-text">实现 FindTransaction</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C"><span class="nav-text">校验</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0VerifyTransaction%E5%87%BD%E6%95%B0"><span class="nav-text">实现VerifyTransaction函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8-Transaction%E4%B8%AD%E6%B7%BB%E5%8A%A0Verify%E7%A9%BA%E5%AE%9E%E7%8E%B0"><span class="nav-text">在 Transaction中添加Verify空实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8AddBlock%E4%B8%AD%E5%AF%B9%E4%BA%A4%E6%98%93%E8%BF%9B%E8%A1%8C%E6%A0%A1%E9%AA%8C"><span class="nav-text">在AddBlock中对交易进行校验</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sig%E7%AD%BE%E5%90%8D%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">Sig签名函数实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TrimmedCopy%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">TrimmedCopy函数实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sign-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">Sign 函数实现</span></a></li></ol></li></ol></li></ol></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2023</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">Lubo</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br> 
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v1.1.3</a>
        </div>
        
        
        
            <div id="start_time_div" style="display:none">
                2023/2/28 00:00:00
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="unfolded-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="folded-tools-list">
        <li class="right-bottom-tools tool-toggle-show flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>



<script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/utils.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/main.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/layouts/menu-shrink.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/tools/go-top-bottom.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/tools/dark-light-toggle.js"></script>


    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/tools/local-search.js"></script>



    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/tools/code-block.js"></script>



    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/layouts/lazyload.js"></script>



    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/tools/runtime.js"></script>
    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/layouts/odometer.min.js"></script>
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/assets/odometer-theme-minimal.css">


<div class="post-scripts pjax">
    
        <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/tools/toc-toggle.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/libs/anime.min.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/layouts/toc.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/plugins/tabs.js"></script>
    
    
</div>


    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.1.3/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            REDEFINE.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            REDEFINE.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            REDEFINE.refresh();
        });
    });
</script>



</body>
</html>
